<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 Test Calendario Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    
    <!-- Header de Test -->
    <div class="bg-gray-800 border-b border-gray-700 p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">🔧 Test Calendario Integrado</h1>
            <div class="flex gap-2">
                <button id="test-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                    🎯 Test Calendario
                </button>
                <button id="reset-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm">
                    🔄 Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Log Area -->
    <div class="p-4 bg-gray-800 border-b border-gray-700">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-sm font-bold mb-2">📝 Log de Debug</h2>
            <div id="log-content" class="text-xs font-mono bg-black p-2 rounded max-h-32 overflow-y-auto">
                <!-- Los logs aparecerán aquí -->
            </div>
        </div>
    </div>

    <!-- Contenedor de la App -->
    <div id="app-container" class="min-h-screen bg-gray-900">
        <div class="flex justify-center items-center h-64">
            <p class="text-gray-400">Haz clic en "Test Calendario" para cargar la app</p>
        </div>
    </div>

    <script>
        // Sistema de logs
        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div class="text-green-400">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function error(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div class="text-red-400">[${timestamp}] ERROR: ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.error(message);
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Cargar la aplicación en un iframe
        async function loadApp() {
            log('🚀 Cargando aplicación en iframe...');
            
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = `
                <iframe 
                    id="app-frame" 
                    src="index-lab.html" 
                    class="w-full h-screen border-0"
                    onload="appLoaded()"
                ></iframe>
            `;
        }

        // Función que se ejecuta cuando la app termina de cargar
        window.appLoaded = async function() {
            log('✅ Aplicación cargada en iframe');
            await wait(2000);
            await testCalendar();
        }

        // Test del calendario
        async function testCalendar() {
            log('🔍 Iniciando test del calendario...');
            
            try {
                const iframe = document.getElementById('app-frame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const iframeWindow = iframe.contentWindow;
                
                // 1. Buscar el botón del calendario
                log('📋 Paso 1: Buscando botón del calendario...');
                const calendarButton = iframeDoc.getElementById('calendar-button');
                
                if (!calendarButton) {
                    error('❌ Botón del calendario no encontrado');
                    return;
                }
                
                log('✅ Botón del calendario encontrado');
                log(`📋 Botón ID: ${calendarButton.id}`);
                log(`📋 Botón Clase: ${calendarButton.className}`);
                
                // 2. Verificar appState
                log('📋 Paso 2: Verificando appState...');
                const appState = iframeWindow.appState;
                
                if (!appState) {
                    error('❌ appState no encontrado');
                    return;
                }
                
                log('✅ appState encontrado');
                log(`📋 Modal activo: ${appState.activeModal || 'ninguno'}`);
                
                // 3. Simular click en el botón del calendario
                log('📋 Paso 3: Simulando click en el botón del calendario...');
                calendarButton.click();
                
                await wait(1000);
                
                // 4. Verificar si el modal se abrió
                log('📋 Paso 4: Verificando modal del calendario...');
                const modalRoot = iframeDoc.getElementById('modal-root');
                
                if (!modalRoot || !modalRoot.innerHTML.trim()) {
                    error('❌ Modal del calendario no se abrió');
                    log(`📋 Estado del modal: ${appState.activeModal || 'ninguno'}`);
                    return;
                }
                
                log('✅ Modal del calendario se abrió correctamente');
                log(`📋 Contenido del modal: ${modalRoot.innerHTML.length} caracteres`);
                
                // 5. Verificar elementos del calendario
                log('📋 Paso 5: Verificando elementos del calendario...');
                
                const yearInput = iframeDoc.getElementById('calendar-year-input');
                const todayBtn = iframeDoc.getElementById('calendar-today-btn');
                const monthButtons = iframeDoc.querySelectorAll('.calendar-month-btn');
                
                log(`📋 Input de año: ${yearInput ? 'ENCONTRADO' : 'NO ENCONTRADO'}`);
                log(`📋 Botón "Ir a Hoy": ${todayBtn ? 'ENCONTRADO' : 'NO ENCONTRADO'}`);
                log(`📋 Botones de mes: ${monthButtons.length} encontrados`);
                
                if (yearInput) {
                    log(`📋 Valor del input de año: "${yearInput.value}"`);
                }
                
                // 6. Test de interacción con el input de año
                if (yearInput) {
                    log('📋 Paso 6: Probando input de año...');
                    const originalYear = yearInput.value;
                    const testYear = '2025';
                    
                    yearInput.value = testYear;
                    yearInput.dispatchEvent(new Event('change'));
                    
                    await wait(500);
                    
                    log(`📋 Input cambió de ${originalYear} a ${testYear}`);
                    log('✅ Input de año funciona correctamente');
                }
                
                // 7. Test de botón de mes
                if (monthButtons.length > 0) {
                    log('📋 Paso 7: Probando botón de mes...');
                    const firstMonthBtn = monthButtons[0];
                    const monthName = firstMonthBtn.textContent.trim();
                    
                    log(`📋 Probando click en: ${monthName}`);
                    firstMonthBtn.click();
                    
                    await wait(1000);
                    
                    // Verificar si el modal se cerró (debería cerrarse al seleccionar mes)
                    const modalAfterClick = iframeDoc.getElementById('modal-root');
                    
                    if (!modalAfterClick || !modalAfterClick.innerHTML.trim()) {
                        log('✅ Modal se cerró correctamente después de seleccionar mes');
                        log('🎉 TEST COMPLETO: Calendario funciona perfectamente');
                    } else {
                        error('❌ Modal no se cerró después de seleccionar mes');
                    }
                }
                
            } catch (err) {
                error(`Error durante el test: ${err.message}`);
                console.error('Error completo:', err);
            }
        }

        // Event listeners
        document.getElementById('test-btn').addEventListener('click', async () => {
            document.getElementById('log-content').innerHTML = '';
            await loadApp();
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('log-content').innerHTML = '';
            document.getElementById('app-container').innerHTML = `
                <div class="flex justify-center items-center h-64">
                    <p class="text-gray-400">Haz clic en "Test Calendario" para cargar la app</p>
                </div>
            `;
            log('🔄 Test reiniciado');
        });

        log('🎯 Test Calendario Integrado listo. Haz clic en "Test Calendario" para comenzar.');
    </script>
</body>
</html>
