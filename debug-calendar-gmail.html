<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóìÔ∏è Debug Calendario + Gmail - Nebula Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos del calendario */
        .calendar-month-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .calendar-month-btn:hover {
            transform: scale(1.05);
        }

        /* Meses con datos - Verde */
        .month-with-data {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        /* Meses sin datos - Gris */
        .month-without-data {
            background: linear-gradient(135deg, #374151, #1f2937) !important;
            color: #9ca3af !important;
        }

        /* Mes actual - Dorado */
        .current-month {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            border: 2px solid #fbbf24 !important;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4 text-yellow-400">üåå Nebula Finance Debug</h1>
            <p class="text-gray-400">Test completo de Calendario + Gmail Login</p>
        </div>

        <!-- Botones principales -->
        <div class="flex justify-center gap-4 mb-8">
            <button id="calendar-btn" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors">
                üóìÔ∏è Abrir Calendario
            </button>
            <button id="gmail-btn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors">
                üìß Login Gmail
            </button>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Calendar Status -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-blue-400">üóìÔ∏è Estado del Calendario</h3>
                <div id="calendar-status" class="space-y-2 text-sm">
                    <div class="text-yellow-400">üîÑ Inicializando...</div>
                </div>
            </div>

            <!-- Gmail Status -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-red-400">üìß Estado de Gmail</h3>
                <div id="gmail-status" class="space-y-2 text-sm">
                    <div class="text-yellow-400">üîÑ Verificando Firebase...</div>
                </div>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="bg-gray-800 rounded-lg p-6 mt-6">
            <h3 class="text-xl font-semibold mb-4 text-green-400">üêõ Debug Console</h3>
            <div id="debug-console" class="bg-black rounded p-4 text-sm font-mono h-64 overflow-y-auto">
                <div class="text-green-400">[INIT] Debug session started...</div>
            </div>
        </div>
    </div>

    <!-- Modal Root -->
    <div id="modal-root"></div>

    <script type="module">
        // Referencias DOM
        const calendarBtn = document.getElementById('calendar-btn');
        const gmailBtn = document.getElementById('gmail-btn');
        const calendarStatus = document.getElementById('calendar-status');
        const gmailStatus = document.getElementById('gmail-status');
        const debugConsole = document.getElementById('debug-console');
        const modalRoot = document.getElementById('modal-root');

        // Utilidades de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-blue-300',
                'success': 'text-green-300',
                'error': 'text-red-300',
                'warning': 'text-yellow-300'
            };
            
            console.log(`[${timestamp}] ${message}`);
            debugConsole.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }

        function updateStatus(element, status, type = 'info') {
            const colors = {
                'info': 'text-blue-300',
                'success': 'text-green-300',
                'error': 'text-red-300',
                'warning': 'text-yellow-300'
            };
            element.innerHTML = `<div class="${colors[type]}">${status}</div>`;
        }

        // === CALENDARIO ===
        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        // Datos simulados
        const testData = {
            2025: {
                1: { hasData: true },
                3: { hasData: true },
                5: { hasData: true },
                6: { hasData: true },
                9: { hasData: true },
                11: { hasData: true }
            }
        };

        function getMonthClass(month) {
            const yearData = testData[currentYear];
            if (!yearData) return 'month-without-data';

            const monthData = yearData[month];
            if (!monthData) return 'month-without-data';

            // Mes actual
            if (month === currentMonth + 1 && currentYear === new Date().getFullYear()) {
                return 'current-month';
            }

            return monthData.hasData ? 'month-with-data' : 'month-without-data';
        }

        function createCalendarModal() {
            log('üìÖ Creando modal del calendario', 'info');
            
            const monthsHTML = months.map((month, index) => `
                <button class="calendar-month-btn p-4 rounded-lg text-center font-semibold ${getMonthClass(index + 1)}"
                        data-month="${index + 1}">
                    ${month}
                </button>
            `).join('');

            modalRoot.innerHTML = `
                <div class="modal-overlay" id="calendar-modal">
                    <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 relative border border-gray-600">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6">
                            <button id="prev-year" class="text-2xl hover:text-yellow-400 transition-colors">‚Üê</button>
                            <h3 id="year-display" class="text-2xl font-bold text-yellow-400">${currentYear}</h3>
                            <button id="next-year" class="text-2xl hover:text-yellow-400 transition-colors">‚Üí</button>
                            <button id="close-calendar" class="absolute top-4 right-4 text-2xl hover:text-red-400 transition-colors">√ó</button>
                        </div>

                        <p class="text-center text-gray-400 mb-4">Selecciona un mes</p>

                        <!-- Grid de Meses -->
                        <div class="grid grid-cols-3 gap-3 mb-6">${monthsHTML}</div>

                        <!-- Leyenda simplificada -->
                        <div class="flex justify-center gap-6 mb-4 text-sm text-gray-400">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-gradient-to-br from-emerald-500 to-emerald-600"></div>
                                <span>Con datos</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-gradient-to-br from-gray-500 to-gray-600"></div>
                                <span>Sin datos</span>
                            </div>
                        </div>

                        <!-- Bot√≥n ir a hoy -->
                        <div class="text-center">
                            <button id="go-to-today" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-semibold transition-colors">
                                üìÖ Ir a Hoy
                            </button>
                        </div>
                    </div>
                </div>
            `;

            addCalendarListeners();
            updateStatus(calendarStatus, '‚úÖ Modal calendario abierto', 'success');
        }

        function addCalendarListeners() {
            const modal = document.getElementById('calendar-modal');
            const closeBtn = document.getElementById('close-calendar');
            const prevYear = document.getElementById('prev-year');
            const nextYear = document.getElementById('next-year');
            const todayBtn = document.getElementById('go-to-today');

            closeBtn?.addEventListener('click', () => {
                log('‚ùå Cerrando calendario', 'info');
                modal.remove();
                updateStatus(calendarStatus, 'üìÖ Calendario disponible', 'info');
            });

            modal?.addEventListener('click', (e) => {
                if (e.target === modal) {
                    log('‚ùå Cerrando por click fuera', 'info');
                    modal.remove();
                    updateStatus(calendarStatus, 'üìÖ Calendario disponible', 'info');
                }
            });

            prevYear?.addEventListener('click', () => {
                currentYear--;
                log(`üìÖ A√±o anterior: ${currentYear}`, 'info');
                updateCalendarDisplay();
            });

            nextYear?.addEventListener('click', () => {
                currentYear++;
                log(`üìÖ A√±o siguiente: ${currentYear}`, 'info');
                updateCalendarDisplay();
            });

            document.querySelectorAll('[data-month]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const month = btn.dataset.month;
                    log(`üìÖ Mes seleccionado: ${months[month-1]} ${currentYear}`, 'success');
                    modal.remove();
                    updateStatus(calendarStatus, `‚úÖ Navegado a ${months[month-1]} ${currentYear}`, 'success');
                });
            });

            todayBtn?.addEventListener('click', () => {
                currentYear = new Date().getFullYear();
                currentMonth = new Date().getMonth();
                log('üìÖ Navegando a hoy', 'success');
                updateCalendarDisplay();
            });
        }

        function updateCalendarDisplay() {
            const yearDisplay = document.getElementById('year-display');
            if (yearDisplay) {
                yearDisplay.textContent = currentYear;
            }

            const monthsGrid = document.querySelector('.grid');
            if (monthsGrid) {
                monthsGrid.innerHTML = months.map((month, index) => `
                    <button class="calendar-month-btn p-4 rounded-lg text-center font-semibold ${getMonthClass(index + 1)}"
                            data-month="${index + 1}">
                        ${month}
                    </button>
                `).join('');

                // Re-agregar listeners
                document.querySelectorAll('[data-month]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const month = btn.dataset.month;
                        log(`üìÖ Mes seleccionado: ${months[month-1]} ${currentYear}`, 'success');
                        document.getElementById('calendar-modal').remove();
                        updateStatus(calendarStatus, `‚úÖ Navegado a ${months[month-1]} ${currentYear}`, 'success');
                    });
                });
            }
        }

        // === FIREBASE / GMAIL ===
        let firebaseAuth = null;
        let googleProvider = null;
        let signInWithPopup = null;

        async function initializeFirebase() {
            try {
                log('üî• Iniciando Firebase...', 'info');
                updateStatus(gmailStatus, 'üîÑ Cargando Firebase...', 'warning');

                // Importar Firebase modules
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
                const { getAuth, GoogleAuthProvider, signInWithPopup: signIn } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
                
                log('‚úÖ M√≥dulos Firebase importados', 'success');

                // Configuraci√≥n (demo para test)
                const firebaseConfig = {
                    apiKey: "AIzaSyBH8kK_ZQJ5vX9vQJ5Z2K6oK9oK9oK9oK9o",
                    authDomain: "nebula-financial-demo.firebaseapp.com",
                    projectId: "nebula-financial-demo",
                    storageBucket: "nebula-financial-demo.appspot.com",
                    messagingSenderId: "123456789012",
                    appId: "1:123456789012:web:demo123456789"
                };

                // Inicializar
                const app = initializeApp(firebaseConfig);
                firebaseAuth = getAuth(app);
                googleProvider = new GoogleAuthProvider();
                signInWithPopup = signIn;

                googleProvider.addScope('email');
                googleProvider.addScope('profile');

                log('‚úÖ Firebase inicializado correctamente', 'success');
                updateStatus(gmailStatus, '‚úÖ Firebase listo para Gmail', 'success');

                // Habilitar bot√≥n
                gmailBtn.disabled = false;
                gmailBtn.textContent = 'üìß Login Gmail';

            } catch (error) {
                log(`‚ùå Error Firebase: ${error.message}`, 'error');
                updateStatus(gmailStatus, '‚ùå Error en Firebase', 'error');
                gmailBtn.textContent = '‚ùå Firebase Error';
            }
        }

        async function loginWithGmail() {
            if (!firebaseAuth || !googleProvider) {
                log('‚ùå Firebase no disponible', 'error');
                return;
            }

            try {
                log('üöÄ Iniciando login con Gmail...', 'info');
                updateStatus(gmailStatus, 'üîÑ Abriendo popup de Gmail...', 'warning');
                
                gmailBtn.textContent = '‚è∞ Abriendo popup...';
                gmailBtn.disabled = true;

                const result = await signInWithPopup(firebaseAuth, googleProvider);
                const user = result.user;
                
                log(`‚úÖ Login exitoso: ${user.displayName} (${user.email})`, 'success');
                updateStatus(gmailStatus, `‚úÖ Conectado: ${user.displayName}`, 'success');
                
                gmailBtn.textContent = '‚úÖ Sesi√≥n Activa';
                gmailBtn.className = 'bg-green-600 px-6 py-3 rounded-lg font-semibold text-white';

            } catch (error) {
                log(`‚ùå Error login: ${error.code} - ${error.message}`, 'error');
                updateStatus(gmailStatus, `‚ùå Error: ${error.code}`, 'error');
                
                gmailBtn.textContent = 'üîÑ Reintentar';
                gmailBtn.disabled = false;
                gmailBtn.className = 'bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors';
            }
        }

        // === EVENT LISTENERS ===
        calendarBtn.addEventListener('click', () => {
            log('üóìÔ∏è Abriendo calendario...', 'info');
            createCalendarModal();
        });

        gmailBtn.addEventListener('click', loginWithGmail);

        // === INICIALIZACI√ìN ===
        log('üéØ Iniciando debug session...', 'info');
        updateStatus(calendarStatus, 'üìÖ Calendario disponible', 'info');
        
        // Inicializar Firebase
        initializeFirebase();

        log('‚úÖ Debug session lista', 'success');
    </script>
</body>
</html>
