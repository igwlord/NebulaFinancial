<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Test Final Calendario - Nebula Financial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .test-button {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .debug-panel {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status-ok { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-warning { color: #f59e0b; }
        
        /* Estilos espec√≠ficos para el modal del calendario */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .calendar-month-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 12px;
            margin: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calendar-month-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .calendar-month-btn.current {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        
        .calendar-month-btn.today {
            background: #10b981;
            color: white;
            border-color: #059669;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">
            üî¨ Test Final del Calendario Optimizado
        </h1>
        
        <div class="test-panel">
            <h2 class="text-2xl font-bold mb-4">üéØ Tests Autom√°ticos</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button class="test-button" onclick="testCalendarOpening()">
                    üìÖ Abrir Calendario
                </button>
                <button class="test-button" onclick="testElementsPresence()">
                    üîç Verificar Elementos
                </button>
                <button class="test-button" onclick="testEventListeners()">
                    üé≠ Probar Eventos
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <button class="test-button" onclick="testYearInput()">
                    üìù Test Input A√±o
                </button>
                <button class="test-button" onclick="testMonthButtons()">
                    üóìÔ∏è Test Botones Mes
                </button>
                <button class="test-button" onclick="runFullTest()">
                    üöÄ Test Completo
                </button>
            </div>
        </div>
        
        <div class="debug-panel" id="debug-output">
            <div class="status-ok">üí° Sistema de Debug Iniciado</div>
            <div class="status-warning">‚ö†Ô∏è Haz clic en cualquier test para comenzar...</div>
        </div>
        
        <!-- Modal para el calendario -->
        <div id="modal-root"></div>
    </div>

    <script>
        // ============================================
        // üéØ SIMULACI√ìN DEL APPSTATE Y FUNCIONES CORE
        // ============================================
        
        const appState = {
            activeModal: null,
            currentDate: new Date(),
            calendarViewYear: new Date().getFullYear(),
            
            openModal: function(modalType) {
                this.activeModal = modalType;
                log(`üìÖ Modal abierto: ${modalType}`, 'ok');
                
                const modalRoot = document.getElementById('modal-root');
                if (modalRoot) {
                    modalRoot.innerHTML = renderCalendarModal();
                    addModalEventListeners();
                }
            },
            
            closeModal: function() {
                log(`‚ùå Cerrando modal: ${this.activeModal}`, 'warning');
                this.activeModal = null;
                
                const modalRoot = document.getElementById('modal-root');
                if (modalRoot) {
                    modalRoot.innerHTML = '';
                }
            }
        };
        
        // ============================================
        // üìÖ RENDERIZADO DEL MODAL DEL CALENDARIO
        // ============================================
        
        function renderCalendarModal() {
            const currentYear = appState.calendarViewYear;
            const today = new Date();
            const currentMonth = today.getMonth();
            
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const monthsGrid = months.map((month, index) => {
                let classes = 'calendar-month-btn';
                if (index === currentMonth && currentYear === today.getFullYear()) {
                    classes += ' today';
                }
                
                return `
                    <button 
                        class="${classes}"
                        data-month-index="${index}"
                        data-month-name="${month}"
                    >
                        ${month}
                    </button>
                `;
            }).join('');
            
            return `
                <div class="modal-overlay" id="calendar-modal-overlay">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">üìÖ Seleccionar Fecha</h2>
                            <button class="modal-close-button text-gray-500 hover:text-gray-700 text-2xl" id="calendar-close-btn">
                                ‚úï
                            </button>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">A√±o:</label>
                            <input 
                                type="number" 
                                id="calendar-year-input" 
                                value="${currentYear}" 
                                min="1900" 
                                max="2100"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">Selecciona un mes:</h3>
                            <div class="grid grid-cols-3 gap-2">
                                ${monthsGrid}
                            </div>
                        </div>
                        
                        <div class="flex justify-between">
                            <button id="calendar-today-btn" class="test-button">
                                üè† Ir a Hoy
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // üé≠ CONFIGURACI√ìN DE EVENTOS DEL MODAL
        // ============================================
        
        function addModalEventListeners() {
            log('üé≠ INICIO addModalEventListeners()', 'ok');
            
            const modalContainer = document.querySelector('.modal-overlay');
            log('üìã Modal container encontrado: ' + (modalContainer ? 'S√ç' : 'NO'), modalContainer ? 'ok' : 'error');
            
            if (modalContainer) {
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        log('üéØ Click en overlay - cerrando modal', 'warning');
                        appState.closeModal();
                    }
                });
            }
            
            // Configurar eventos espec√≠ficos del calendario
            if (appState.activeModal === 'calendar') {
                log('üéØ Configurando eventos espec√≠ficos del calendario...', 'ok');
                
                setTimeout(() => {
                    log('üéØ Ejecutando configuraci√≥n con delay...', 'ok');
                    try {
                        setupCalendarModalEvents();
                        log('‚úÖ setupCalendarModalEvents() completado', 'ok');
                    } catch (error) {
                        log('‚ùå Error en setupCalendarModalEvents(): ' + error.message, 'error');
                    }
                }, 100);
            }
        }
        
        function setupCalendarModalEvents() {
            log('üîß INICIO setupCalendarModalEvents()', 'ok');
            
            setTimeout(() => {
                const yearInput = document.getElementById('calendar-year-input');
                const todayBtn = document.getElementById('calendar-today-btn');
                const closeBtn = document.getElementById('calendar-close-btn');
                const monthButtons = document.querySelectorAll('.calendar-month-btn');
                
                log('üîç Elementos encontrados:', 'ok');
                log('   - Input a√±o: ' + (yearInput ? 'ENCONTRADO' : 'NO ENCONTRADO'), yearInput ? 'ok' : 'error');
                log('   - Bot√≥n hoy: ' + (todayBtn ? 'ENCONTRADO' : 'NO ENCONTRADO'), todayBtn ? 'ok' : 'error');
                log('   - Bot√≥n cerrar: ' + (closeBtn ? 'ENCONTRADO' : 'NO ENCONTRADO'), closeBtn ? 'ok' : 'error');
                log('   - Botones mes: ' + monthButtons.length + ' encontrados', monthButtons.length > 0 ? 'ok' : 'error');
                
                if (yearInput && monthButtons.length > 0) {
                    setupCleanCalendarEvents(yearInput, todayBtn, closeBtn, monthButtons);
                } else {
                    log('‚ùå No se pudieron obtener elementos para configurar', 'error');
                }
            }, 50);
        }
        
        function setupCleanCalendarEvents(yearInput, todayBtn, closeBtn, monthButtons) {
            log('üßΩ Configurando eventos limpios...', 'ok');
            
            // Event Listener: Input de a√±o
            if (yearInput) {
                log('‚úÖ Configurando eventos del input de a√±o...', 'ok');
                
                yearInput.addEventListener('change', (e) => {
                    log('üéØ Input a√±o - evento change: ' + e.target.value, 'ok');
                    const newYear = parseInt(e.target.value);
                    if (!isNaN(newYear) && newYear >= 1900 && newYear <= 2100) {
                        appState.calendarViewYear = newYear;
                        log('üìÖ A√±o actualizado a: ' + newYear, 'ok');
                    }
                });
                
                yearInput.addEventListener('keydown', (e) => {
                    log('üéØ Input a√±o - keydown: ' + e.key, 'ok');
                    if (e.key === 'Enter') {
                        const newYear = parseInt(e.target.value);
                        if (!isNaN(newYear)) {
                            appState.calendarViewYear = newYear;
                            log('üìÖ A√±o actualizado via Enter: ' + newYear, 'ok');
                        }
                    }
                });
            }
            
            // Event Listener: Bot√≥n "Ir a hoy"
            if (todayBtn) {
                log('‚úÖ Configurando bot√≥n "Ir a Hoy"...', 'ok');
                todayBtn.addEventListener('click', () => {
                    log('üè† Bot√≥n "Ir a Hoy" clickeado', 'ok');
                    const today = new Date();
                    appState.currentDate = today;
                    appState.calendarViewYear = today.getFullYear();
                    appState.closeModal();
                });
            }
            
            // Event Listener: Bot√≥n cerrar
            if (closeBtn) {
                log('‚úÖ Configurando bot√≥n cerrar...', 'ok');
                closeBtn.addEventListener('click', () => {
                    log('‚ùå Bot√≥n cerrar clickeado', 'warning');
                    appState.closeModal();
                });
            }
            
            // Event Listeners: Botones de meses
            log('‚úÖ Configurando eventos de botones de mes...', 'ok');
            monthButtons.forEach((btn, index) => {
                const monthIndex = parseInt(btn.getAttribute('data-month-index'));
                const monthName = btn.getAttribute('data-month-name');
                
                log('   - Configurando bot√≥n ' + (index + 1) + ': ' + monthName + ' (√≠ndice: ' + monthIndex + ')', 'ok');
                
                btn.addEventListener('click', () => {
                    log('üéØ CLICK en mes: ' + monthName + ' (√≠ndice: ' + monthIndex + ')', 'ok');
                    selectMonth(monthIndex);
                });
                
                btn.style.cursor = 'pointer';
                btn.style.pointerEvents = 'auto';
            });
            
            log('‚úÖ TODOS LOS EVENTOS CONFIGURADOS CORRECTAMENTE', 'ok');
        }
        
        function selectMonth(monthIndex) {
            const year = appState.calendarViewYear;
            const monthName = new Date(year, monthIndex).toLocaleString('es-ES', {month: 'long', year: 'numeric'});
            
            appState.currentDate = new Date(year, monthIndex, 1);
            log('üìÖ Mes seleccionado: ' + monthName, 'ok');
            
            // Simular cierre del modal
            appState.closeModal();
            log('‚úÖ Navegaci√≥n completada correctamente', 'ok');
        }
        
        // ============================================
        // üî¨ FUNCIONES DE TESTING
        // ============================================
        
        function log(message, type = 'ok') {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = 'status-' + type;
            
            const logLine = document.createElement('div');
            logLine.className = statusClass;
            logLine.textContent = `[${timestamp}] ${message}`;
            
            debugOutput.appendChild(logLine);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        function clearDebug() {
            document.getElementById('debug-output').innerHTML = '';
        }
        
        function testCalendarOpening() {
            clearDebug();
            log('üöÄ INICIANDO TEST DE APERTURA DE CALENDARIO', 'ok');
            
            try {
                appState.openModal('calendar');
                
                setTimeout(() => {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        log('‚úÖ Modal renderizado correctamente', 'ok');
                    } else {
                        log('‚ùå Modal no se renderiz√≥', 'error');
                    }
                }, 200);
                
            } catch (error) {
                log('‚ùå Error al abrir calendario: ' + error.message, 'error');
            }
        }
        
        function testElementsPresence() {
            log('üîç VERIFICANDO PRESENCIA DE ELEMENTOS...', 'ok');
            
            const elements = {
                'Modal overlay': document.querySelector('.modal-overlay'),
                'Input a√±o': document.getElementById('calendar-year-input'),
                'Bot√≥n hoy': document.getElementById('calendar-today-btn'),
                'Bot√≥n cerrar': document.getElementById('calendar-close-btn'),
                'Botones mes': document.querySelectorAll('.calendar-month-btn')
            };
            
            Object.entries(elements).forEach(([name, element]) => {
                if (name === 'Botones mes') {
                    const count = element.length;
                    log(`   ${name}: ${count} encontrados`, count === 12 ? 'ok' : 'error');
                } else {
                    log(`   ${name}: ${element ? 'ENCONTRADO' : 'NO ENCONTRADO'}`, element ? 'ok' : 'error');
                }
            });
        }
        
        function testEventListeners() {
            log('üé≠ PROBANDO EVENT LISTENERS...', 'ok');
            
            // Test input a√±o
            const yearInput = document.getElementById('calendar-year-input');
            if (yearInput) {
                log('üìù Probando input de a√±o...', 'ok');
                yearInput.focus();
                yearInput.value = '2025';
                yearInput.dispatchEvent(new Event('change'));
            }
            
            // Test bot√≥n cerrar
            const closeBtn = document.getElementById('calendar-close-btn');
            if (closeBtn) {
                log('‚ùå Probando bot√≥n cerrar...', 'warning');
                setTimeout(() => closeBtn.click(), 1000);
            }
        }
        
        function testYearInput() {
            log('üìù TEST ESPEC√çFICO DEL INPUT DE A√ëO', 'ok');
            
            const yearInput = document.getElementById('calendar-year-input');
            if (!yearInput) {
                log('‚ùå Input de a√±o no encontrado', 'error');
                return;
            }
            
            // Test cambio de valor
            yearInput.value = '2030';
            yearInput.dispatchEvent(new Event('change'));
            log('‚úÖ Evento change disparado con valor 2030', 'ok');
            
            // Test tecla Enter
            const enterEvent = new KeyboardEvent('keydown', { key: 'Enter' });
            yearInput.dispatchEvent(enterEvent);
            log('‚úÖ Evento keydown Enter disparado', 'ok');
        }
        
        function testMonthButtons() {
            log('üóìÔ∏è TEST ESPEC√çFICO DE BOTONES DE MES', 'ok');
            
            const monthButtons = document.querySelectorAll('.calendar-month-btn');
            if (monthButtons.length === 0) {
                log('‚ùå No se encontraron botones de mes', 'error');
                return;
            }
            
            log(`üìä Encontrados ${monthButtons.length} botones de mes`, 'ok');
            
            // Probar el primer bot√≥n (Enero)
            const firstButton = monthButtons[0];
            if (firstButton) {
                const monthName = firstButton.getAttribute('data-month-name');
                log(`üéØ Probando click en: ${monthName}`, 'ok');
                
                setTimeout(() => {
                    firstButton.click();
                    log(`‚úÖ Click ejecutado en ${monthName}`, 'ok');
                }, 500);
            }
        }
        
        function runFullTest() {
            clearDebug();
            log('üöÄ INICIANDO SUITE COMPLETA DE TESTS', 'ok');
            
            // Secuencia de tests
            testCalendarOpening();
            
            setTimeout(() => testElementsPresence(), 300);
            setTimeout(() => testEventListeners(), 600);
            setTimeout(() => testYearInput(), 900);
            setTimeout(() => testMonthButtons(), 1200);
            
            setTimeout(() => {
                log('üèÅ SUITE DE TESTS COMPLETADA', 'ok');
                log('üìä Revisa los logs anteriores para verificar resultados', 'warning');
            }, 1500);
        }
        
        // ============================================
        // üéØ INICIALIZACI√ìN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            log('üí° Test de Calendario Final - Sistema iniciado', 'ok');
            log('üéØ Haz clic en "Test Completo" para una verificaci√≥n autom√°tica', 'warning');
        });
    </script>
</body>
</html>
