<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    
    <!-- üöÄ OPTIMIZACI√ìN NUCLEAR - Cache Busting Inteligente -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- üåå NEBULA IDENTITY - SEO Optimizado -->
    <title>üåå Nebula Financial - Tu Universo Financiero √âpico</title>
    <meta name="description" content="La experiencia financiera m√°s avanzada del universo. Gestiona ingresos, gastos, inversiones y deudas con inteligencia gal√°ctica.">
    <meta name="keywords" content="finanzas personales, gesti√≥n financiera, presupuesto, inversiones, nebula">
    <meta name="author" content="Nebula Financial Team">
    
    <!-- üéØ PERFORMANCE CRITICAL - Recursos Prioritarios -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
      <!-- üöÄ FUENTES - Carga Optimizada -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"></noscript>    <!-- üî• FIREBASE - Autenticaci√≥n y Servicios -->
    <script type="module">
        // Importar configuraci√≥n y funciones de Firebase (con cache-buster)
        const timestamp = Date.now();
        const { getFirebaseConfig } = await import(`./firebase-config.js?t=${timestamp}`);
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';        try {
            console.log('üî• Inicializando Firebase...');
            
            // Obtener configuraci√≥n desde firebase-config.js
            const firebaseConfig = getFirebaseConfig();
            
            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            
            // Configurar el proveedor de Google
            provider.addScope('email');
            provider.addScope('profile');
            
            // Hacer disponible globalmente
            window.firebaseAuth = auth;
            window.googleProvider = provider;
            window.signInWithPopup = signInWithPopup;
            window.signOut = signOut;
            window.onAuthStateChanged = onAuthStateChanged;
            window.firebaseAvailable = true;
            
            console.log('‚úÖ Firebase inicializado correctamente con configuraci√≥n desde .env');
            
            // Notificar a NebulaAuth que Firebase est√° listo
            if (window.NebulaAuth && typeof window.NebulaAuth.initializeAuth === 'function') {
                console.log('üîÑ Reinicializando NebulaAuth con Firebase...');
                window.NebulaAuth.initializeAuth();
            }
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Error inicializando Firebase:', error);
            console.log('üí° La app funcionar√° en modo local sin autenticaci√≥n de Google');
            
            // Marcar Firebase como no disponible
            window.firebaseAvailable = false;
        }
    </script>
    
    <!-- üé® ICONOS Y MANIFEST -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåå</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FCD34D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nebula Financial">
    
    <!-- üéØ CSS CR√çTICO - Inline para LCP √©pico -->
    <style>
        /* üöÄ CRITICAL CSS - Primera Impresi√≥n √âpica */
        :root {
            --nebula-primary: #1e40af;
            --nebula-secondary: #7c3aed;
            --nebula-accent: #fcd34d;
            --nebula-gold: #ffd700;
            --nebula-dark: #0f0f23;
            --nebula-darker: #0a0a1a;
            --nebula-glass: rgba(255, 255, 255, 0.1);
            --nebula-glow: 0 0 20px rgba(252, 211, 77, 0.5);
            --nebula-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--nebula-dark);
            color: var(--nebula-accent);
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* üåå LOADING √âPICO - Primera Impresi√≥n */
        .nebula-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .nebula-loading.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .nebula-logo {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #fcd34d, #ffd700, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            animation: nebulaGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes nebulaGlow {
            from { filter: drop-shadow(0 0 10px rgba(252, 211, 77, 0.5)); }
            to { filter: drop-shadow(0 0 25px rgba(252, 211, 77, 0.8)); }
        }
        
        .nebula-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid transparent;
            border-top: 3px solid var(--nebula-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* üéØ LAYOUT CR√çTICO */
        #app-container {
            min-height: 100vh;
            position: relative;
        }
        
        #content-root {
            position: relative;
            z-index: 10;
            padding-bottom: 6rem;
            min-height: 100vh;
        }
        
        #dock-root {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }
        
        #parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            perspective: 1000px;
            pointer-events: none;
        }
        
        /* üöÄ ANIMACIONES √âPICAS */
        .nebula-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .nebula-slide-up {
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* üé® GLASSMORPHISM √âPICO */
        .nebula-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }
        
        /* üî• HOVER EFFECTS √âPICOS */
        .nebula-hover {
            transition: var(--nebula-transition);
            cursor: pointer;
        }
        
        .nebula-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--nebula-glow);
        }
          /* üì± RESPONSIVE √âPICO */
        @media (max-width: 768px) {
            .nebula-logo { font-size: 3rem; }
            #content-root { padding-bottom: 5rem; }
        }
        
        /* üé® CSS EXTENDIDO - Animaciones para efectos de part√≠culas */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }
        
        @keyframes glow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.4); }
        }
        
        @keyframes drift {
            0% { transform: translateX(0px) translateY(0px); opacity: 0.1; }
            50% { transform: translateX(100px) translateY(-50px); opacity: 0.3; }
            100% { transform: translateX(200px) translateY(0px); opacity: 0.1; }
        }
        
        @keyframes wave {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.3; }
        }
          @keyframes orbit {
            0% { transform: rotate(0deg) translateX(var(--radius)) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(var(--radius)) rotate(-360deg); }
        }
        
        /* üé® SISTEMA DE VALIDACI√ìN VISUAL */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444 !important;
        }
        
        .field-error-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 500;
            animation: slideInError 0.3s ease-out;
        }
        
        @keyframes slideInError {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .field-error-message svg {
            width: 0.875rem;
            height: 0.875rem;
            flex-shrink: 0;
        }
          .input-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 1px #10b981 !important;
        }

        /* üé≠ SISTEMA DE MODALES ELEGANTE */
        .nebula-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nebula-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nebula-modal {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            min-width: 320px;
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .nebula-modal-overlay.active .nebula-modal {
            transform: scale(1) translateY(0);
        }

        .nebula-modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .nebula-modal-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nebula-modal-icon.warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .nebula-modal-icon.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .nebula-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .nebula-modal-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .nebula-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .nebula-modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nebula-modal-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nebula-modal-button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nebula-modal-button.primary {
            background: #3b82f6;
            color: white;
        }

        .nebula-modal-button.primary:hover {
            background: #2563eb;
        }

        .nebula-modal-button.danger {
            background: #ef4444;
            color: white;
        }

        .nebula-modal-button.danger:hover {
            background: #dc2626;
        }

        @media (max-width: 640px) {
            .nebula-modal {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .nebula-modal-actions {
                flex-direction: column-reverse;
            }
            
            .nebula-modal-button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    
    <!-- üéØ TAILWIND - Sin configuraci√≥n problem√°tica -->
      <!-- üöÄ TAILWIND CDN - Carga Diferida Inteligente -->
    <script>
        // üî• SUPER CACHE-BUSTING PARA DEPURACI√ìN
        const CACHE_BUSTER = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('üî• Cache-Buster activo:', CACHE_BUSTER);
        
        // üéØ CARGA INTELIGENTE DE TAILWIND
        const loadTailwind = () => {
            if (!document.getElementById('tailwind-css')) {
                const script = document.createElement('script');
                script.id = 'tailwind-css';
                script.src = 'https://cdn.tailwindcss.com';
                script.async = true;
                script.onload = () => {
                    console.log('‚úÖ Tailwind CSS cargado exitosamente');
                };
                script.onerror = () => {
                    console.error('‚ùå Error cargando Tailwind CSS');
                };
                document.head.appendChild(script);
                console.log('üé® Tailwind CSS cargado din√°micamente');
            }
        };
        
        // Cargar Tailwind cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadTailwind);
        } else {
            loadTailwind();
        }
    </script>
    
    <!-- üìä CHART.JS - Carga S√∫per Diferida -->
    <script>
        // üöÄ CARGA CHARTS SOLO CUANDO SEA NECESARIO
        window.loadChartJS = function() {
            return new Promise((resolve, reject) => {
                if (window.Chart) {
                    resolve(window.Chart);
                    return;
                }
                
                console.log('üìä Cargando Chart.js din√°micamente...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js';
                script.async = true;
                script.onload = () => {
                    console.log('‚úÖ Chart.js cargado exitosamente');
                    resolve(window.Chart);
                };
                script.onerror = () => {
                    console.error('‚ùå Error cargando Chart.js');
                    reject(new Error('Failed to load Chart.js'));
                };
                document.head.appendChild(script);
            });
        };
        
        // üéØ PRECARGAR CHART.JS EN BACKGROUND DESPU√âS DE 2 SEGUNDOS
        setTimeout(() => {
            if (!window.Chart) {
                window.loadChartJS().catch(console.error);
            }
        }, 2000);
    </script>
    
    <!-- üé® CSS EXTERNO - Carga Optimizada -->
    <script>
        // üöÄ CARGA DIFERIDA DE CSS NO CR√çTICO
        const loadCSS = (href, id) => {
            if (!document.getElementById(id)) {
                const link = document.createElement('link');
                link.id = id;
                link.rel = 'stylesheet';
                link.href = href;
                link.media = 'print';
                link.onload = function() { 
                    this.media = 'all'; 
                    console.log(`üé® CSS ${id} cargado`);
                };
                document.head.appendChild(link);
            }
        };
        
        // Cargar CSS no cr√≠tico despu√©s del DOM
        document.addEventListener('DOMContentLoaded', () => {
            loadCSS('css/styles.css', 'styles-css');
            loadCSS('css/optimized.css', 'optimized-css');
        });
    </script>
</head>
<body>
    <!-- üåå LOADING SCREEN √âPICO -->
    <div id="nebula-loading" class="nebula-loading">
        <div class="text-center">
            <div class="nebula-logo">üåå Nebula</div>
            <div class="text-lg font-medium text-nebula-300 mt-4">Inicializando tu universo financiero...</div>
            <div class="nebula-spinner mx-auto"></div>        </div>
    </div>

    <!-- üåå APLICACI√ìN PRINCIPAL - Container √âpico -->
    <div id="app-container">
        <div id="parallax-bg" class="fixed inset-0 z-0 perspective-[1000px]"></div>
        <main id="content-root" class="relative z-10 pb-24 nebula-fade-in" aria-label="Contenido principal de la aplicaci√≥n"></main>
        <div id="dock-root" class="fixed bottom-0 left-0 right-0 z-20"></div>
        <div id="modal-root" class="fixed inset-0 z-50"></div>

        <!-- üé≠ SISTEMA DE MODALES ELEGANTE -->
        <div id="nebula-modal-overlay" class="nebula-modal-overlay">
            <div class="nebula-modal">
                <div class="nebula-modal-header">
                    <div id="nebula-modal-icon" class="nebula-modal-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <h3 id="nebula-modal-title" class="nebula-modal-title">Confirmaci√≥n</h3>
                </div>
                <div id="nebula-modal-content" class="nebula-modal-content">
                    ¬øEst√°s seguro de que deseas realizar esta acci√≥n?
                </div>
                <div class="nebula-modal-actions">
                    <button id="nebula-modal-cancel" class="nebula-modal-button secondary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancelar
                    </button>
                    <button id="nebula-modal-confirm" class="nebula-modal-button primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
        <div id="notification-container" class="notification-container"></div>
    </div>    <!-- üîí SEGURIDAD CR√çTICA - Carga Prioritaria -->
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="js/utils/security.js"></script>
    <script src="js/utils/input-validation.js"></script>
    
    <!-- üöÄ SISTEMA DE CARGA MODULAR √âPICO -->
    <script>
        // üéØ M√ìDULOS NEBULA - Configuraci√≥n Inteligente
        const NEBULA_MODULES = {
            // üî• CR√çTICOS - Carga inmediata
            critical: [
                'js/modules/dashboard.js',
                'js/modules/dock-navigation.js'
            ],
            // ‚ö° IMPORTANTES - Carga r√°pida
            important: [
                'js/modules/settings.js',
                'js/modules/grid-cards.js'
            ],            // üåü FUNCIONALES - Carga diferida
            functional: [
                'js/modules/income-new.js',
                'js/modules/expenses-new.js',
                'js/modules/goals-new.js',
                'js/modules/investments-new.js',
                'js/modules/debts-new.js'
            ],            // üé® EXTRAS - Sin calendarios
            extras: [
                // Calendarios eliminados completamente
            ]
        };
        
        // üöÄ CARGADOR MODULAR INTELIGENTE
        class NebulaModuleLoader {
            constructor() {
                this.loaded = new Set();
                this.loading = new Map();
                this.totalModules = Object.values(NEBULA_MODULES).flat().length;
                this.loadedCount = 0;
            }
              async loadModule(src) {
                if (this.loaded.has(src)) return true;
                if (this.loading.has(src)) return this.loading.get(src);
                
                const promise = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    // üî• CACHE-BUST AGRESIVO
                    script.src = `${src}?v=${Date.now()}&cb=${Math.random()}`;
                    script.async = true;
                    
                    script.onload = () => {
                        this.loaded.add(src);
                        this.loadedCount++;
                        this.updateProgress();
                        console.log(`‚úÖ ${src.split('/').pop()} cargado (${this.loadedCount}/${this.totalModules})`);
                        resolve(true);
                    };
                    
                    script.onerror = () => {
                        console.error(`‚ùå Error cargando ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    };
                    
                    document.head.appendChild(script);
                });
                
                this.loading.set(src, promise);
                return promise;
            }
            
            async loadModuleGroup(group, groupName) {
                console.log(`üöÄ Cargando grupo ${groupName}...`);
                const promises = group.map(src => this.loadModule(src));
                
                try {
                    await Promise.all(promises);
                    console.log(`‚úÖ Grupo ${groupName} completado`);
                    return true;
                } catch (error) {
                    console.error(`‚ùå Error en grupo ${groupName}:`, error);
                    return false;
                }
            }
            
            updateProgress() {
                const progress = (this.loadedCount / this.totalModules) * 100;
                const progressText = document.querySelector('#nebula-loading .text-lg');
                if (progressText) {
                    progressText.textContent = `Cargando m√≥dulos... ${Math.round(progress)}%`;
                }
                
                // Ocultar loading cuando est√© completo
                if (this.loadedCount === this.totalModules) {
                    setTimeout(() => this.hideLoading(), 500);
                }
            }
            
            hideLoading() {
                const loading = document.getElementById('nebula-loading');
                if (loading) {
                    loading.classList.add('hidden');
                    setTimeout(() => loading.remove(), 500);
                }
                console.log('üéâ Todos los m√≥dulos cargados - UI lista');
            }
            
            async loadAll() {
                try {
                    // üî• Fase 1: M√≥dulos cr√≠ticos (paralelo)
                    await this.loadModuleGroup(NEBULA_MODULES.critical, 'CR√çTICO');
                    
                    // ‚ö° Fase 2: M√≥dulos importantes (paralelo)
                    await this.loadModuleGroup(NEBULA_MODULES.important, 'IMPORTANTE');
                    
                    // üåü Fase 3: M√≥dulos funcionales (paralelo con delay)
                    setTimeout(() => {
                        this.loadModuleGroup(NEBULA_MODULES.functional, 'FUNCIONAL');
                    }, 100);
                    
                    // üé® Fase 4: M√≥dulos extras (bajo demanda)
                    setTimeout(() => {
                        this.loadModuleGroup(NEBULA_MODULES.extras, 'EXTRAS');
                    }, 500);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico cargando m√≥dulos:', error);
                    return false;
                }
            }
        }
        
        // üöÄ INICIALIZAR CARGA INTELIGENTE
        const moduleLoader = new NebulaModuleLoader();
        window.nebulaModuleLoader = moduleLoader; // Disponible globalmente
        
        // Iniciar carga cuando DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => moduleLoader.loadAll());
        } else {
            moduleLoader.loadAll();
        }
    </script>
      <!-- üåå APLICACI√ìN PRINCIPAL - Motor de Inicializaci√≥n -->
    <script type="module">
        // üöÄ NEBULA FINANCIAL v3.0 - LABORATORIO √âPICO
        console.log('üåå Iniciando Nebula Financial v3.0 - LABORATORIO √âPICO');
        
        // üåü FUNCIONES GLOBALES CR√çTICAS - Exponer ANTES de cargar m√≥dulos
        const formatNumberWithDots = (value) => {
            if (!value) return '';
            const numStr = value.toString().replace(/\D/g, '');
            return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        };
        
        const formatCurrency = (value) => value != null ? `$${formatNumberWithDots(value)}` : '$0';
        
        // Exponer globalmente INMEDIATAMENTE
        window.formatCurrency = formatCurrency;
        window.formatNumberWithDots = formatNumberWithDots;
        window.parseNumberWithDots = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        };
        
        console.log('‚úÖ Funciones globales cr√≠ticas expuestas');
          // üîí INICIALIZAR SEGURIDAD CR√çTICA
        if (typeof window.NebulaSecurityUtils !== 'undefined') {
            window.NebulaSecurityUtils.init();
            console.log('üîí Sistema de seguridad Nebula inicializado');
        }
        
        if (typeof NebulaInputValidator !== 'undefined') {
            console.log('üîí Sistema de validaci√≥n de entrada inicializado');
        }
        
        // üéØ TIMESTAMP Y VERSION TRACKING
        const buildTimestamp = Date.now();
        console.log('üïê TIMESTAMP CARGA:', new Date().toISOString(), 'Cache-bust activo');
        console.log('üîÑ VERSION C√ìDIGO:', `v3.0_LAB_EPIC_${buildTimestamp}`);
        console.log('üöÄ OPTIMIZACIONES √âPICAS APLICADAS');
        
        // üåü FUNCI√ìN DE ESPERA INTELIGENTE PARA M√ìDULOS
        const waitForModules = () => {
            return new Promise((resolve) => {
                const checkModules = () => {
                    if (window.nebulaModuleLoader && window.nebulaModuleLoader.loadedCount >= 4) {
                        resolve();
                    } else {
                        setTimeout(checkModules, 50);
                    }
                };
                checkModules();
            });
        };        // üöÄ INICIALIZACI√ìN √âPICA DE LA APLICACI√ìN
        const initNebulaEpic = async () => {
            try {
                console.log('‚è≥ Esperando m√≥dulos cr√≠ticos...');
                await waitForModules();
                
                // üéØ IMPORTAR SOLO THEMES (appState ya est√° embebido)
                const { THEMES } = await import('./js/utils/helpers.js');
                
                // üåç HACER THEMES DISPONIBLE PARA startNebula
                window.THEMES = THEMES;                console.log('‚úÖ THEMES cargado, iniciando aplicaci√≥n...');
                
                // üöÄ VERIFICAR DOM ANTES DE INICIALIZAR
                const domReady = ['content-root', 'dock-root', 'parallax-bg', 'modal-root']
                    .every(id => document.getElementById(id));
                
                console.log('üîç DOM Ready:', domReady, 'nebulaStarted:', window.nebulaStarted || false);
                
                if (domReady && !window.nebulaStarted) {
                    console.log('üöÄ Ejecutando startNebula desde initNebulaEpic...');
                    startNebula();
                } else {
                    console.log('‚è≥ Skipping startNebula - DOM no listo o ya iniciado');
                }
                
                console.log('üéâ Nebula Financial inicializado correctamente');
                
                // ÔøΩ EFECTOS VISUALES √âPICOS POST-CARGA
                document.body.classList.add('nebula-loaded');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                
                // üÜò FALLBACK INTELIGENTE
                console.log('üîÑ Activando fallback a versi√≥n estable...');
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 2000);
            }
        };
        
        // üéØ INICIALIZAR CUANDO TODO EST√â LISTO
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNebulaEpic);
        } else {
            initNebulaEpic();
        }
        
        // üîí FUNCIONES DE SEGURIDAD - Protecci√≥n XSS
        /**
         * Sanitiza strings para prevenir ataques XSS
         * @param {string} str - String a sanitizar
         * @returns {string} String sanitizado
         */        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Exponer sanitizeHTML globalmente para los m√≥dulos
        window.sanitizeHTML = sanitizeHTML;

        /**
         * Sanitiza objetos con propiedades de texto
         * @param {object} obj - Objeto a sanitizar
         * @returns {object} Objeto sanitizado
         */
        function sanitizeObject(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const sanitized = {};
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string') {
                    sanitized[key] = sanitizeHTML(value);
                } else if (typeof value === 'object') {
                    sanitized[key] = sanitizeObject(value);
                } else {
                    sanitized[key] = value;
                }
            }
            return sanitized;
        }

        /**
         * Establece innerHTML de forma segura
         * @param {Element} element - Elemento DOM
         * @param {string} html - HTML a insertar (ser√° sanitizado si contiene entrada de usuario)
         * @param {boolean} trusted - Si el HTML viene de c√≥digo confiable (default: true)
         */
        function safeSetInnerHTML(element, html, trusted = true) {
            if (!element) return;
            if (trusted) {
                element.innerHTML = html; // HTML confiable del c√≥digo de la app
            } else {
                element.textContent = html; // Entrada de usuario - solo texto
            }
        }

        /**
         * üé® DEFINICI√ìN DE TEMAS VISUALES
         * Cada tema define colores, gradientes y efectos de part√≠culas √∫nicos
         * Todos centrados alrededor del SOL como estrella principal de la aplicaci√≥n
         */
        const THEMES = {            aureoAmanecer: { 
                name: '√Åureo Amanecer', 
                gradient: 'radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffd700\' fill-opacity=\'0.1\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-amber-300', 
                accentBg: 'bg-amber-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,191,36,0.8)]', 
                accentColor: '#FCD34D', 
                accentBorder: 'border-amber-300', 
                accentRing: 'focus:ring-amber-300', 
                positive: 'text-emerald-300', 
                negative: 'text-rose-300', 
                surface: 'bg-black/20 border-amber-200/30 backdrop-blur-md', 
                textPrimary: 'text-amber-50', 
                textSecondary: 'text-amber-200/80', 
                particleType: 'goldenDust',
                sunColor: '#FFD700'
            },            crisonVespertino: { 
                name: 'Cris√≥n Vespertino', 
                gradient: 'radial-gradient(ellipse at center, #2d1b3d 0%, #4a1942 40%, #1a0f1a 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ff6b9d\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-rose-300', 
                accentBg: 'bg-rose-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,113,133,0.8)]', 
                accentColor: '#FB7185', 
                accentBorder: 'border-rose-300', 
                accentRing: 'focus:ring-rose-300', 
                positive: 'text-teal-300', 
                negative: 'text-orange-300', 
                surface: 'bg-black/20 border-rose-200/30 backdrop-blur-md', 
                textPrimary: 'text-rose-50', 
                textSecondary: 'text-rose-200/80', 
                particleType: 'crimsonMist',
                sunColor: '#FF4C6A'
            },            aguamarinaCeleste: { 
                name: 'Aguamarina Celeste', 
                gradient: 'radial-gradient(ellipse at center, #0f2027 0%, #203a43 40%, #0c1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%2367e8f9\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-cyan-300', 
                accentBg: 'bg-cyan-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(103,232,249,0.8)]', 
                accentColor: '#67E8F9', 
                accentBorder: 'border-cyan-300', 
                accentRing: 'focus:ring-cyan-300', 
                positive: 'text-lime-300', 
                negative: 'text-amber-300', 
                surface: 'bg-black/20 border-cyan-200/30 backdrop-blur-md', 
                textPrimary: 'text-cyan-50', 
                textSecondary: 'text-cyan-200/80', 
                particleType: 'aquaFlow',
                sunColor: '#00CED1'
            },            violetaReal: { 
                name: 'Violeta Real', 
                gradient: 'radial-gradient(ellipse at center, #1e1b4b 0%, #312e81 40%, #111827 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23a855f7\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-purple-300', 
                accentBg: 'bg-purple-500', 
                accentGlow: 'shadow-[0_0_25px_rgba(168,85,247,0.8)]', 
                accentColor: '#A855F7', 
                accentBorder: 'border-purple-300', 
                accentRing: 'focus:ring-purple-300', 
                positive: 'text-green-300', 
                negative: 'text-red-300', 
                surface: 'bg-black/20 border-purple-200/30 backdrop-blur-md', 
                textPrimary: 'text-purple-50', 
                textSecondary: 'text-purple-200/80', 
                particleType: 'royalAura',
                sunColor: '#8B5CF6'
            }
        };/**
         * üéØ ICONOS SVG VECTORIALES
         * Conjunto de iconos optimizados para la interfaz
         */
        const ICONS = {            dashboard: `<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/>`,
            income: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4-4 4 4"/><path d="M12 8v8"/>`,
            expenses: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/>`,
            goals: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1"/>`,
            investments: `<path d="M3 3v18h18"/><path d="m4 14 4-4 4 4 6-6"/>`,
            debts: `<rect x="1" y="4" width="22" height="16" rx="3" ry="3"/><line x1="1" y1="10" x2="23" y2="10"/>`,
            achievements: `<path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>`,
            settings: `<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`,
            plus: `<path d="M12 5v14m-7-7h14" />`,
            trash: `<path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>`,
            eye: `<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>`,
            eyeOff: `<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 11 8 11 8a18.35 18.35 0 0 1-2.18 3.2M3.5 12a10.43 10.43 0 0 1 2.22-3.2"/><path d="M1 1l22 22"/>`,            chevronLeft: `<path d="m15 18-6-6 6-6"/>`,
            chevronRight: `<path d="m9 18 6-6-6-6"/>`,
            chevronDown: `<path d="m6 9 6 6 6-6"/>`,
            history: `<path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>`,
            mail: `<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>`,
            zap: `<path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>`,            x: `<path d="M18 6 6 18M6 6l12 12"/>`,
            // CloudSonnet4: √çCONO CALENDARIO RESTAURADO - Necesario para navegaci√≥n
            calendar: `<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>`,
            check: `<polyline points="20 6 9 17 4 12"/>`,
            alertCircle: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/>`,
            info: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/>`,
            alertTriangle: `<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/>`,
            repeat: `<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
            copy: `<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>`,
            logOut: `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>`,
            download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>`
        };
        
        /**
         * üìÇ CATEGOR√çAS DE GASTOS DISPONIBLES
         * Lista predefinida para categorizaci√≥n de transacciones
         */
        const CATEGORIES = ['Comida', 'Transporte', 'Ocio', 'Hogar', 'Salud', 'Educaci√≥n', 'Regalos', 'Varios'];        // ===============================================
        // üîî SISTEMA DE NOTIFICACIONES MODERNO
        // ===============================================
        
        /**
         * üì¢ Gestor de Notificaciones
         * Sistema completo para mostrar mensajes al usuario de forma no invasiva
         */
        const NotificationSystem = {
            container: null,
            
            init() {
                this.container = document.getElementById('notification-container');
            },
            
            /**
             * Muestra una notificaci√≥n
             * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
             * @param {string} title - T√≠tulo de la notificaci√≥n
             * @param {string} message - Mensaje descriptivo
             * @param {number} duration - Duraci√≥n en ms (default: 4000)
             */
            show(type = 'info', title = '', message = '', duration = 4000) {
                if (!this.container) this.init();
                
                const id = Date.now().toString();
                const iconMap = {
                    success: ICONS.check,
                    error: ICONS.alertCircle,
                    warning: ICONS.alertTriangle,
                    info: ICONS.info
                };
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                  notification.innerHTML = `
                    <button class="notification-close" onclick="NotificationSystem.remove('${id}')" aria-label="Cerrar notificaci√≥n" role="button">
                        ${createIcon(ICONS.x, 'w-4 h-4')}
                    </button>
                    <div class="notification-header">
                        ${createIcon(iconMap[type] || iconMap.info, 'w-5 h-5')}
                        <span>${title}</span>
                    </div>
                    <div class="notification-body">${message}</div>
                `;
                
                this.container.appendChild(notification);
                
                // Trigger animation
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });
                
                // Auto remove
                if (duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }
                
                return id;
            },
            
            remove(id) {
                const notification = document.getElementById(`notification-${id}`);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }
            },
            
            // M√©todos convenientes
            success(title, message, duration) {
                return this.show('success', title, message, duration);
            },
            
            error(title, message, duration) {
                return this.show('error', title, message, duration);
            },
            
            warning(title, message, duration) {
                return this.show('warning', title, message, duration);
            },
            
            info(title, message, duration) {
                return this.show('info', title, message, duration);
            }
        };
        
        /**
         * üéÆ GESTOR CENTRAL DEL ESTADO
         * Maneja toda la l√≥gica de negocio y persistencia de datos
         */
        const appState = {
            // --- Estado de Usuario y Sesi√≥n ---
            user: JSON.parse(sessionStorage.getItem('financialUser')) || null,
            isLoading: false,
            activeView: 'dashboard',
            activeModal: null,            // --- Configuraci√≥n y Preferencias ---
            isPrivate: (() => {
                try {
                    return (typeof window.NebulaSecurityUtils !== 'undefined') ? 
                        window.NebulaSecurityUtils.secureGetItem('isPrivateMode', true) :
                        JSON.parse(localStorage.getItem('isPrivateMode')) ?? true;
                } catch { return true; }
            })(),
            
            themeKey: (() => {
                try {
                    return (typeof window.NebulaSecurityUtils !== 'undefined') ? 
                        window.NebulaSecurityUtils.secureGetItem('financialTheme', 'aureoAmanecer') :
                        localStorage.getItem('financialTheme') || 'aureoAmanecer';
                } catch { return 'aureoAmanecer'; }
            })(),// --- Estado Temporal de Navegaci√≥n ---
            currentDate: new Date(),
            // CloudSonnet4: VARIABLE CALENDAR RESTAURADA - Necesaria para modal calendario
            calendarViewYear: new Date().getFullYear(),
            calendarView: 'months', // 'months' o 'years' para cambiar vista del modal            // --- Datos Financieros Principales ---
            data: (() => {
                try {
                    const defaultData = { transactions: {}, goals: [], investments: [], debts: [] };
                    return (typeof window.NebulaSecurityUtils !== 'undefined') ? 
                        window.NebulaSecurityUtils.secureGetItem('financialData', defaultData) :
                        JSON.parse(localStorage.getItem('financialData')) || defaultData;
                } catch { 
                    return { transactions: {}, goals: [], investments: [], debts: [] }; 
                }
            })(),
              // --- Getters Computados ---
            get theme() { 
                return THEMES[this.themeKey]; 
            },
            
            get currentMonthKey() { 
                return `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}`; 
            },
              // üé® M√©todo para obtener tema actual (compatibilidad con m√≥dulos)
            getCurrentTheme() {
                return this.theme;
            },
              // --- Persistencia de Datos ---
            saveState() {
                try {
                    // üîê Sincronizar con perfil de usuario autenticado si disponible
                    if (this.user && this.user.provider === 'google' && window.nebulaAuth) {
                        console.log('üîê Sincronizando datos con perfil de usuario...');
                        
                        // Preparar datos financieros para sincronizaci√≥n
                        const financialData = {
                            transactions: this.data.transactions,
                            goals: this.data.goals,
                            investments: this.data.investments,
                            debts: this.data.debts,
                            theme: this.themeKey,
                            isPrivate: this.isPrivate,
                            lastUpdate: Date.now()
                        };
                        
                        // Intentar guardar en el perfil del usuario
                        window.nebulaAuth.updateUserProfile({ financialData })
                            .then(() => {
                                console.log('‚úÖ Datos sincronizados con perfil de usuario');
                            })
                            .catch(error => {
                                console.warn('‚ö†Ô∏è Error sincronizando con perfil:', error);
                                // Continuar con guardado local como fallback
                            });
                    }
                      // üîí Guardar localmente (siempre como backup)
                    if (typeof window.NebulaSecurityUtils !== 'undefined') {
                        // Usar almacenamiento seguro cifrado
                        window.NebulaSecurityUtils.secureSetItem('financialTheme', this.themeKey);
                        window.NebulaSecurityUtils.secureSetItem('financialData', this.data);
                        window.NebulaSecurityUtils.secureSetItem('isPrivateMode', this.isPrivate);
                        console.log('üîí Estado guardado de forma segura localmente');
                    } else {
                        // Fallback a localStorage normal
                        localStorage.setItem('financialTheme', this.themeKey);
                        localStorage.setItem('financialData', JSON.stringify(this.data));
                        localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                        console.log('‚ö†Ô∏è Estado guardado sin cifrado (fallback)');
                    }
                } catch (error) {
                    console.error('‚ùå Error guardando estado:', error);
                    // √öltimo recurso: localStorage directo
                    localStorage.setItem('financialTheme', this.themeKey);
                    localStorage.setItem('financialData', JSON.stringify(this.data));                    localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                }
            },
              // --- Autenticaci√≥n ---
            async login(method) {
                this.isLoading = true; 
                renderApp(); 
                
                try {
                    // üîê Usar sistema de autenticaci√≥n Nebula si est√° disponible
                    if (window.nebulaAuth && window.nebulaAuthUI) {
                        console.log('üîê Usando sistema de autenticaci√≥n Nebula...');
                        
                        if (method === 'google') {
                            const result = await window.nebulaAuth.signInWithGoogle();
                            
                            if (result.success) {
                                console.log('‚úÖ Login exitoso con Nebula Auth:', result.user);
                                
                                this.user = {
                                    name: result.user.displayName || result.profile?.displayName || 'Usuario de Google',
                                    email: result.user.email || result.profile?.email,
                                    photoURL: result.user.photoURL || result.profile?.photoURL,
                                    uid: result.user.uid,
                                    provider: 'google',
                                    profile: result.profile
                                };
                                
                                // Cargar datos del perfil si existen
                                if (result.profile?.financialData) {
                                    Object.assign(this.data, result.profile.financialData);
                                }
                                
                                NotificationSystem.success(
                                    '¬°Bienvenido!', 
                                    `Hola ${this.user.name}, tu perfil est√° sincronizado`
                                );
                            } else {
                                throw new Error(result.error || 'Error en autenticaci√≥n Nebula');
                            }
                            
                        } else if (method === 'guest') {
                            // Login como invitado con Nebula
                            this.user = { 
                                name: 'Invitado',
                                provider: 'guest'
                            };
                            
                            // Guardar en sessionStorage
                            sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                            
                            NotificationSystem.info(
                                'Modo Invitado', 
                                'Est√°s usando la app sin sincronizaci√≥n'
                            );
                        }
                        
                    } else {
                        // üî• Fallback al sistema b√°sico de Firebase
                        console.log('‚ö†Ô∏è Nebula Auth no disponible, usando Firebase b√°sico...');
                        
                        if (method === 'google') {
                            // Verificar que Firebase est√© disponible
                            if (!window.firebaseAuth || !window.googleProvider || !window.signInWithPopup) {
                                throw new Error('Firebase no est√° disponible');
                            }
                            
                            console.log('üî• Iniciando login con Google...');
                            
                            // Intentar login con Google
                            const result = await window.signInWithPopup(window.firebaseAuth, window.googleProvider);
                            const user = result.user;
                            
                            console.log('‚úÖ Login exitoso:', user);
                            
                            // Configurar usuario autenticado
                            this.user = {
                                name: user.displayName || 'Usuario de Google',
                                email: user.email,
                                photoURL: user.photoURL,
                                uid: user.uid,
                                provider: 'google'
                            };
                              // Guardar sesi√≥n
                            if (typeof window.NebulaSecurityUtils !== 'undefined') {
                                window.NebulaSecurityUtils.secureSetItem('financialUser', this.user);
                                window.NebulaSecurityUtils.secureSetItem('userSession', {
                                    loginTime: Date.now(),
                                    provider: 'google'
                                });
                            } else {
                                sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                            }
                            
                            NotificationSystem.success(
                                '¬°Bienvenido!', 
                                `Hola ${this.user.name}, tu sesi√≥n est√° activa`
                            );
                            
                        } else {
                            // Login como invitado (sin Firebase)
                            this.user = { 
                                name: 'Invitado',
                                provider: 'guest'
                            };
                            sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                            
                            NotificationSystem.info(
                                'Modo Invitado', 
                                'Est√°s usando la app sin sincronizaci√≥n'
                            );
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en login:', error);
                    
                    let errorMessage = 'Error desconocido';
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Login cancelado por el usuario';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Popup bloqueado. Permite popups para este sitio';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Error de conexi√≥n. Verifica tu internet';
                    } else if (error.message.includes('Firebase no est√° disponible')) {
                        errorMessage = 'Servicio de autenticaci√≥n no disponible. Intenta como invitado';
                    } else {
                        errorMessage = error.message || 'Error al iniciar sesi√≥n';
                    }
                    
                    NotificationSystem.error('Error de Login', errorMessage);
                    
                    // En caso de error, ofrecer login como invitado
                    if (method === 'google') {
                        setTimeout(() => {
                            if (confirm('¬øDeseas continuar como invitado?')) {
                                this.login('guest');
                                return;
                            }
                        }, 2000);
                    }
                }
                
                this.isLoading = false;
                renderApp(); 
            },
            
            // Funci√≥n para cerrar sesi√≥n
            async logout() {
                try {
                    if (this.user?.provider === 'google' && window.firebaseAuth) {
                        await window.signOut(window.firebaseAuth);
                        console.log('‚úÖ Sesi√≥n de Google cerrada');
                    }
                    
                    // Limpiar datos de sesi√≥n                    this.user = null;
                    if (typeof window.NebulaSecurityUtils !== 'undefined') {
                        window.NebulaSecurityUtils.secureRemoveItem('financialUser');
                        window.NebulaSecurityUtils.secureRemoveItem('userSession');
                    } else {
                        sessionStorage.removeItem('financialUser');
                    }
                    
                    NotificationSystem.success('Sesi√≥n cerrada', 'Has cerrado sesi√≥n exitosamente');
                    renderApp();
                    
                } catch (error) {
                    console.error('‚ùå Error cerrando sesi√≥n:', error);
                    NotificationSystem.error('Error', 'Error al cerrar sesi√≥n');
                }
            },
            
            // --- Configuraci√≥n Visual ---
            setTheme(key) { 
                this.themeKey = key; 
                this.saveState(); 
                renderApp(); 
            },
            
            setView(view) { 
                this.activeView = view; 
                renderApp(); 
            },
            
            togglePrivacy() { 
                this.isPrivate = !this.isPrivate; 
                this.saveState(); 
                renderApp(); 
            },
              // --- Navegaci√≥n Temporal ---
            changeMonth(direction) { 
                this.currentDate.setMonth(this.currentDate.getMonth() + direction); 
                renderApp(); 
            },
              // CloudSonnet4: FUNCI√ìN CR√çTICA RESTAURADA - Selecci√≥n de mes desde modal calendario
            // üîß SOLUCI√ìN: Funci√≥n setCalendarDate necesaria para navegaci√≥n desde modal
            setCalendarDate(monthIndex) {
                this.currentDate = new Date(this.calendarViewYear, monthIndex, 1);
                this.closeModal(true); // Cerrar modal y refrescar app
            },
              // CloudSonnet4: FUNCIONES CALENDARIO RESTAURADAS - Navegaci√≥n completa de a√±os
            // --- Navegaci√≥n de Calendario ---
            changeCalendarYear(direction) { 
                this.calendarViewYear += direction; 
                renderModal(); 
            },

            changeCalendarDecade(direction) {
                this.calendarViewYear += direction * 10;
                renderModal();
            },

            switchCalendarView(view = null) {
                if (view) {
                    this.calendarView = view;
                } else {
                    this.calendarView = this.calendarView === 'months' ? 'years' : 'months';
                }
                renderModal();
            },

            selectCalendarYear(year) {
                this.calendarViewYear = parseInt(year);
                this.calendarView = 'months';
                renderModal();
            },
            
            setCalendarYear(year) { 
                if(year > 1900 && year < 2200) this.calendarViewYear = year; 
                renderModal(); 
            },            goToToday() { 
                const today = new Date();
                this.currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                this.calendarViewYear = today.getFullYear(); 
                this.calendarView = 'months'; // Resetear vista a meses
                this.closeModal(true); // Cerrar modal y refrescar app
            },            // --- Gesti√≥n de Modales ---
            openModal(modalType) {
                // CloudSonnet4: MODAL CALENDARIO RESTAURADO - Funcionalidad completa habilitada
                if (modalType === 'calendar') {
                    this.calendarViewYear = this.currentDate.getFullYear();
                    this.calendarView = 'months'; // Siempre empezar en vista de meses
                }
                this.activeModal = modalType;
                renderModal();
            },
            
            closeModal(shouldRenderAppAfter = false) {
                const modalContainer = document.querySelector('.modal-container');
                if (modalContainer) {
                    modalContainer.classList.remove('modal-enter');
                    modalContainer.classList.add('modal-leave');
                    modalContainer.addEventListener('animationend', () => {
                        this.activeModal = null;
                        renderModal(); 
                        if (shouldRenderAppAfter) renderApp();
                    }, { once: true });
                } else {
                     this.activeModal = null;
                     if (shouldRenderAppAfter) renderApp();
                }
            },// --- Gesti√≥n de Transacciones ---
            addTransaction(t) {
                const key = this.currentMonthKey;
                if (!this.data.transactions[key]) this.data.transactions[key] = [];
                this.data.transactions[key].push({ 
                    ...t, 
                    id: Date.now(), 
                    date: new Date().toISOString() 
                });
                this.saveState();
                renderApp();
            },
            
            deleteTransaction(id) {
                const key = this.currentMonthKey;
                if(this.data.transactions[key]) {
                    this.data.transactions[key] = this.data.transactions[key].filter(t => t.id !== id);
                    this.saveState();
                    renderApp();
                }
            },
              repeatPreviousMonth(type) {
                const prevDate = new Date(this.currentDate);
                prevDate.setMonth(prevDate.getMonth() - 1);
                const prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
                const prevTransactions = this.data.transactions[prevKey] || [];
                const transactionsToCopy = prevTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length > 0) {
                    transactionsToCopy.forEach(t => this.addTransaction({ 
                        ...t, 
                        date: new Date().toISOString() 
                    }));
                    NotificationSystem.success('√âxito', 
                        `Se copiaron ${transactionsToCopy.length} transacciones del mes anterior`);
                } else {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones del mes anterior para copiar');
                }
            },
            
            /**
             * üìÖ Repite transacciones actuales hasta fin de a√±o
             * @param {string} type - Tipo de transacci√≥n ('income' o 'expense')
             */
            repeatYearlyFromCurrent(type) {
                const currentTransactions = this.data.transactions[this.currentMonthKey] || [];
                const transactionsToCopy = currentTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length === 0) {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones en el mes actual para copiar');
                    return;
                }
                
                const currentYear = this.currentDate.getFullYear();
                const currentMonth = this.currentDate.getMonth();
                let totalCopied = 0;
                
                // Copiar a todos los meses restantes del a√±o
                for (let month = currentMonth + 1; month < 12; month++) {
                    const targetKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                    
                    if (!this.data.transactions[targetKey]) {
                        this.data.transactions[targetKey] = [];
                    }
                    
                    transactionsToCopy.forEach(t => {
                        const newTransaction = {
                            ...t,
                            id: Date.now() + Math.random(), // ID √∫nico
                            date: new Date(currentYear, month, new Date(t.date).getDate()).toISOString()
                        };
                        this.data.transactions[targetKey].push(newTransaction);
                        totalCopied++;
                    });
                }
                
                if (totalCopied > 0) {
                    this.saveState();
                    NotificationSystem.success('√âxito', 
                        `Se copiaron ${totalCopied} transacciones hasta fin de a√±o`);
                } else {
                    NotificationSystem.info('Sin cambios', 
                        'Ya es diciembre o no hay meses restantes');
                }
            },
            
            // --- Gesti√≥n de Metas ---
            addGoal(g) { 
                this.data.goals.push({ 
                    ...g, 
                    id: Date.now(), 
                    saved: 0 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteGoal(id) { 
                this.data.goals = this.data.goals.filter(goal => goal.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Gesti√≥n de Inversiones ---
            addInvestment(i) { 
                this.data.investments.push({ 
                    ...i, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteInvestment(id) { 
                this.data.investments = this.data.investments.filter(inv => inv.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            updateInvestment(id, newAmount) {
                const investment = this.data.investments.find(inv => inv.id === id);
                if (investment) investment.currentAmount = newAmount;
                this.saveState();
                if(this.activeView === 'investments') {
                    document.querySelector('#content-root > main').innerHTML = renderInvestmentsView();
                }
            },
            
            // --- Gesti√≥n de Deudas ---
            addDebt(d) { 
                this.data.debts.push({ 
                    ...d, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteDebt(id) { 
                this.data.debts = this.data.debts.filter(debt => debt.id !== id); 
                this.saveState(); 
                renderApp(); 
            }        };
        
        // üåê Exponer appState globalmente INMEDIATAMENTE
        window.appState = appState;
        console.log('‚úÖ appState expuesto globalmente');

        // ===============================================
        // üîß UTILIDADES Y FUNCIONES AUXILIARES
        // ===============================================
        /**
         * üî¢ Convierte n√∫mero formateado a n√∫mero plano
         * @param {string} value - Valor formateado con puntos
         * @returns {number} N√∫mero sin formato
         */
        const parseFormattedNumber = (value) => parseFloat(String(value).replace(/\./g, '')) || 0;
          // Exponer funciones adicionales globalmente
        window.parseFormattedNumber = parseFormattedNumber;
        
        /**
         * üé® SISTEMA DE VALIDACI√ìN VISUAL
         * CloudSonnet4: Sistema modular para mensajes de error elegantes
         */
        
        // Funci√≥n para mostrar error en campo espec√≠fico
        function showFieldError(inputElement, message) {
            if (!inputElement) return;
            
            // Remover error previo
            clearFieldError(inputElement);
            
            // Agregar clase de error al input
            inputElement.classList.add('input-error');
            inputElement.setAttribute('aria-invalid', 'true');
            
            // Crear mensaje de error
            const errorElement = document.createElement('div');
            errorElement.className = 'field-error-message';
            errorElement.id = `${inputElement.id || inputElement.name}-error`;
            errorElement.setAttribute('role', 'alert');
            errorElement.innerHTML = `
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                ${message}
            `;
            
            // Insertar despu√©s del input
            inputElement.parentNode.insertBefore(errorElement, inputElement.nextSibling);
            
            // Configurar aria-describedby
            inputElement.setAttribute('aria-describedby', errorElement.id);
            
            // Auto-clear cuando el usuario escriba
            const clearOnInput = () => {
                clearFieldError(inputElement);
                inputElement.removeEventListener('input', clearOnInput);
            };
            inputElement.addEventListener('input', clearOnInput);
        }
        
        // Funci√≥n para limpiar error de campo
        function clearFieldError(inputElement) {
            if (!inputElement) return;
            
            inputElement.classList.remove('input-error');
            inputElement.classList.add('input-success');
            inputElement.removeAttribute('aria-invalid');
            
            // Remover mensaje de error
            const errorId = `${inputElement.id || inputElement.name}-error`;
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.remove();
            }
            
            // Limpiar aria-describedby
            inputElement.removeAttribute('aria-describedby');
            
            // Remover clase success despu√©s de un tiempo
            setTimeout(() => {
                inputElement.classList.remove('input-success');
            }, 2000);
        }
        
        // Funci√≥n para validar campo obligatorio
        function validateField(inputElement, fieldName) {
            const value = inputElement.value.trim();
            if (!value) {
                showFieldError(inputElement, `Por favor ingresa ${fieldName}`);
                return false;
            }
            clearFieldError(inputElement);
            return true;
        }
        
        // Funci√≥n para validar formulario completo
        function validateForm(formElement) {
            const requiredFields = formElement.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                const fieldName = field.getAttribute('data-field-name') || 
                                 field.previousElementSibling?.textContent || 
                                 'este campo';
                
                if (!validateField(field, fieldName)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
          // CloudSonnet4: Exponer funciones globalmente para uso en m√≥dulos
        window.showFieldError = showFieldError;
        window.clearFieldError = clearFieldError;
        window.validateField = validateField;
        window.validateForm = validateForm;

        /**
         * üé≠ SISTEMA DE MODALES ELEGANTE
         * CloudSonnet4: Reemplazo profesional para alert() y confirm()
         */
        
        // Funci√≥n para mostrar modal de confirmaci√≥n
        function showConfirmModal(title, content, type = 'warning', options = {}) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('nebula-modal-overlay');
                const modalTitle = document.getElementById('nebula-modal-title');
                const modalContent = document.getElementById('nebula-modal-content');
                const modalIcon = document.getElementById('nebula-modal-icon');
                const cancelButton = document.getElementById('nebula-modal-cancel');
                const confirmButton = document.getElementById('nebula-modal-confirm');
                
                // Configurar contenido
                modalTitle.textContent = title;
                modalContent.innerHTML = content;
                
                // Configurar icono seg√∫n tipo
                modalIcon.className = `nebula-modal-icon ${type}`;
                if (type === 'danger') {
                    modalIcon.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    `;
                } else {
                    modalIcon.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    `;
                }
                
                // Configurar botones
                cancelButton.textContent = options.cancelText || 'Cancelar';
                confirmButton.textContent = options.confirmText || 'Confirmar';
                
                // Configurar estilo del bot√≥n de confirmar
                confirmButton.className = `nebula-modal-button ${type === 'danger' ? 'danger' : 'primary'}`;
                
                // Funci√≥n para cerrar modal
                const closeModal = () => {
                    overlay.classList.remove('active');
                    document.removeEventListener('keydown', handleKeydown);
                };
                
                // Manejar teclas
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        resolve(false);
                    } else if (e.key === 'Enter') {
                        closeModal();
                        resolve(true);
                    }
                };
                
                // Event listeners
                const handleCancel = () => {
                    closeModal();
                    resolve(false);
                };
                
                const handleConfirm = () => {
                    closeModal();
                    resolve(true);
                };
                
                // Limpiar listeners previos
                cancelButton.removeEventListener('click', handleCancel);
                confirmButton.removeEventListener('click', handleConfirm);
                
                // A√±adir listeners
                cancelButton.addEventListener('click', handleCancel);
                confirmButton.addEventListener('click', handleConfirm);
                document.addEventListener('keydown', handleKeydown);
                
                // Cerrar al hacer clic fuera del modal
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal();
                        resolve(false);
                    }
                });
                
                // Mostrar modal
                overlay.classList.add('active');
                
                // Focus en el bot√≥n de cancelar para accesibilidad
                setTimeout(() => cancelButton.focus(), 100);
            });
        }
        
        // Funciones de conveniencia para diferentes tipos de modales
        const showWarningModal = (title, content, options = {}) => 
            showConfirmModal(title, content, 'warning', options);
            
        const showDangerModal = (title, content, options = {}) => 
            showConfirmModal(title, content, 'danger', options);
        
        // CloudSonnet4: Exponer funciones globalmente
        window.showConfirmModal = showConfirmModal;
        window.showWarningModal = showWarningModal;
        window.showDangerModal = showDangerModal;
        
        /**
         * üé® Crea elemento SVG de icono
         * @param {string} path - Path del icono SVG
         * @param {string} className - Clases CSS adicionales
         * @returns {string} HTML del icono SVG
         */
        const createIcon = (path, className = "w-6 h-6") => 
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;

        // ===============================================
        // üèóÔ∏è REFERENCIAS DOM PRINCIPALES        // ===============================================
        // üéØ REFERENCIAS A ELEMENTOS DEL DOM (se inicializan m√°s tarde)
        // ===============================================
        
        let contentRoot, dockRoot, parallaxBg, modalRoot;// ===============================================
        // üñºÔ∏è FUNCIONES DE RENDERIZADO PRINCIPAL
        // ===============================================
        
        /**
         * Renderiza la vista activa seg√∫n el estado de la aplicaci√≥n.
         * @returns {string} HTML de la vista activa
         */
        function renderViewByState() {
            let viewHTML = '';

            // Agregar selector de mes para vistas espec√≠ficas
            const viewsWithMonthSelector = ['settings', 'achievements', 'goals', 'investments', 'debts'];
            if (!viewsWithMonthSelector.includes(appState.activeView)) {
                viewHTML += renderMonthSelector();
            }

            // Mapeo de vistas a funciones de renderizado
            const viewRenderers = {
                'dashboard': () => window.NebulaDashboardModule ? window.NebulaDashboardModule.render() : renderDashboard(),
                'income': () => window.NebulaIncomeModule ? window.NebulaIncomeModule.render() : renderTransactionsView('income'),
                'expenses': () => window.NebulaExpensesModule ? window.NebulaExpensesModule.render() : renderTransactionsView('expense'),
                'goals': () => window.NebulaGoalsModule ? window.NebulaGoalsModule.render() : renderGoalsView(),
                'investments': () => window.NebulaInvestmentsModule ? window.NebulaInvestmentsModule.render() : renderInvestmentsView(),
                'debts': () => window.NebulaDebtsModule ? window.NebulaDebtsModule.render() : renderDebtsView(),
                'settings': () => window.NebulaSettingsModule ? window.NebulaSettingsModule.render() : renderSettingsView(),
                'default': () => renderComingSoon(appState.activeView)
            };

            // Renderizar vista seg√∫n la selecci√≥n activa
            viewHTML += (viewRenderers[appState.activeView] || viewRenderers['default'])();

            return viewHTML;
        }

        /**
         * üéØ Renderizador principal de la aplicaci√≥n
         * Controla el flujo de renderizado seg√∫n el estado actual de la aplicaci√≥n.
         */
        function renderApp() {
            // Renderizar part√≠culas de fondo
            parallaxBg.innerHTML = renderParallaxBackground();

            if (appState.isLoading) {
                // Mostrar pantalla de carga
                contentRoot.innerHTML = renderLoadingScreen();
                dockRoot.innerHTML = '';
            } else if (!appState.user) {
                // Mostrar vista de login si no hay usuario autenticado
                contentRoot.innerHTML = renderLoginView();
                dockRoot.innerHTML = '';
            } else {
                // Renderizar vista activa
                contentRoot.innerHTML = `<main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto w-full view-transition">${renderViewByState()}</main>`;
                dockRoot.innerHTML = renderDock();
            }

            addEventListeners();

            // Actualizar glider despu√©s del renderizado
            setTimeout(() => updateDockGlider(), 100);
        }

        /**
         * üìÖ Modal de calendario con navegaci√≥n avanzada
         * Renderiza un modal para seleccionar meses y a√±os con indicadores visuales.
         * @returns {string} HTML del modal de calendario
         */
        function renderCalendarModal() {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const today = new Date();
            const currentSelectedDate = appState.currentDate;

            // Generar botones de meses
            const monthsHTML = months.map((month, index) => {
                const isCurrentMonth = today.getFullYear() === currentSelectedDate.getFullYear() && today.getMonth() === index;
                const isSelectedMonth = currentSelectedDate.getMonth() === index;

                let monthClass = 'bg-gray-600/20 border-gray-500/30 text-gray-300';
                if (isCurrentMonth) {
                    monthClass = `${appState.theme.accentBg} text-slate-900 font-black border-2 ${appState.theme.accentBorder}`;
                } else if (isSelectedMonth) {
                    monthClass += ' ring-2 ring-white/50';
                }

                return `<button data-month-index="${index}" class="month-button p-4 rounded-lg ${monthClass}">${month}</button>`;
            }).join('');

            return `
                <div class="modal-container fixed inset-0 z-50 flex items-center justify-center bg-black/70">
                    <div class="modal-content relative p-6 ${appState.theme.surface} w-full max-w-lg">
                        <div class="grid grid-cols-3 gap-3">${monthsHTML}</div>
                    </div>
                </div>
            `;
        }
    </script>
      <!-- üîß M√ìDULOS DE NEBULA FINANCIAL -->
    <script type="module">
        // Cargar m√≥dulos de forma as√≠ncrona
        import('./js/modules/investments.js').then(module => {
            // El m√≥dulo ya se auto-inicializa, solo verificamos que est√© disponible
            console.log('‚úÖ M√≥dulo de Inversiones cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de inversiones:', error);
        });
        
        import('./js/modules/goals.js').then(module => {
            // El m√≥dulo ya se auto-inicializa, solo verificamos que est√© disponible
            console.log('‚úÖ M√≥dulo de Metas cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de metas:', error);
        });
        
        import('./js/modules/debts.js').then(module => {
            // El m√≥dulo ya se auto-inicializa, solo verificamos que est√© disponible
            console.log('‚úÖ M√≥dulo de Deudas cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de deudas:', error);
        });
        
        import('./js/modules/income.js').then(module => {
            // Asegurarse de que el m√≥dulo est√© disponible globalmente
            if (!window.NebulaIncomeModule && window.IncomeModule) {
                window.NebulaIncomeModule = window.IncomeModule;
            }
            console.log('‚úÖ M√≥dulo de Ingresos cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de ingresos:', error);
        });
        
        import('./js/modules/expenses.js').then(module => {
            // Asegurarse de que el m√≥dulo est√© disponible globalmente
            if (!window.NebulaExpensesModule && window.ExpensesModule) {
                window.NebulaExpensesModule = window.ExpensesModule;
            }
            console.log('‚úÖ M√≥dulo de Gastos cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de gastos:', error);
        });    </script>    <!-- üîê SISTEMA DE AUTENTICACI√ìN NEBULA - Integraci√≥n Completa -->
    <script src="nebula-auth.js"></script>
    <script src="nebula-auth-ui.js"></script>

    <!-- Fase 1: Mejoras de UX/UI -->

        <!-- 1. Feedback Visual Mejorado -->
        <style>
            button {
                transition: all 0.3s ease;
            }
            button:hover {
                transform: scale(1.05);
                opacity: 0.9;
            }
        </style>

        <!-- 2. Accesibilidad -->
        <script>
            document.querySelectorAll('button, a').forEach(el => {
                if (!el.hasAttribute('aria-label')) {
                    el.setAttribute('aria-label', el.textContent.trim() || 'Bot√≥n');
                }
            });
        </script>

        <!-- 3. Dise√±o Responsivo -->
        <style>
            @media (max-width: 768px) {
                .responsive-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <!-- 4. Indicadores de Progreso -->
        <style>
            .loading-spinner {
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-left-color: #09f;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
        <script>
            function showLoadingSpinner() {
                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                document.body.appendChild(spinner);
            }
            function hideLoadingSpinner() {
                const spinner = document.querySelector('.loading-spinner');
                if (spinner) spinner.remove();
            }
        </script>

        <!-- 5. Modo Oscuro/Claro -->
        <style>
            :root {
                --bg-color: #ffffff;
                --text-color: #000000;
            }
            [data-theme='dark'] {
                --bg-color: #000000;
                --text-color: #ffffff;
            }
            body {
                background-color: var(--bg-color);
                color: var(--text-color);
                transition: background-color 0.3s, color 0.3s;
            }
        </style>
        <script>
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            }
            document.addEventListener('DOMContentLoaded', () => {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            });
        </script>
        <button onclick="toggleTheme()">Cambiar Tema</button>

        <!-- Fase 2: Mejoras de Seguridad -->

        <!-- 1. Protecci√≥n Contra XSS -->
        <script>
            function escapeHTML(str) {
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }
            // Usar escapeHTML antes de insertar contenido generado por el usuario en el DOM
        </script>

        <!-- 2. Cifrado de Datos Sensibles -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script>
            function encryptData(key, data) {
                return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
            }
            function decryptData(key, encryptedData) {
                const bytes = CryptoJS.AES.decrypt(encryptedData, key);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            }
            // Ejemplo: localStorage.setItem('data', encryptData('secret-key', { example: 'data' }));
        </script>

        <!-- 3. Pol√≠tica de Seguridad de Contenidos (CSP) -->
        <!-- Esto debe configurarse en el servidor, pero se documenta aqu√≠ -->
        <!-- Ejemplo: Content-Security-Policy: default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com -->

        <!-- 4. Validaci√≥n de Entradas -->
        <script>
            function validateInput(input, regex) {
                return regex.test(input);
            }
            // Ejemplo: validateInput(userInput, /^[a-zA-Z0-9_]+$/);
        </script>

        <!-- 5. Autenticaci√≥n M√°s Segura -->
        <script>
            function setSessionToken(token, expirationMinutes) {
                const expirationTime = new Date().getTime() + expirationMinutes * 60000;
                sessionStorage.setItem('sessionToken', encryptData('secret-key', { token, expirationTime }));
            }
            function isSessionValid() {
                const sessionData = sessionStorage.getItem('sessionToken');
                if (!sessionData) return false;
                const { expirationTime } = decryptData('secret-key', sessionData);
                return new Date().getTime() < expirationTime;
            }
            // Usar isSessionValid para verificar la validez de la sesi√≥n
        </script>
</body>
</html>
