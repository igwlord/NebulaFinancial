<!DOCTYPE html>
<html lang="es">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Nebula - Tu Universo Financiero</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌌</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FCD34D">
    
    <!-- 🚀 Preload recursos críticos para performance -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap"></noscript>
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" as="script">
    
    <!-- CSS Crítico para LCP optimizado -->
    <link rel="stylesheet" href="css/critical.css">
    
    <!-- CSS No Crítico - Carga asíncrona -->
    <link rel="preload" href="css/styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/styles.css"></noscript><script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* 🚀 CSS CRÍTICO MÍNIMO - Solo para evitar FOUC */
        body { 
            margin: 0; 
            background: #000; 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        /* Dock positioning crítico */
        .dock-container { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 20; 
        }
        /* Content spacing crítico */
        #content-root { 
            padding-bottom: 96px; 
        }    </style>
</head>
<body>    <div id="app-container">
        <div id="parallax-bg" class="fixed inset-0 z-0 perspective-[1000px]"></div>
        <div id="content-root" class="relative z-10 pb-24" role="main" aria-label="Contenido principal de la aplicación"></div>
        <div id="dock-root" class="fixed bottom-0 left-0 right-0 z-20"></div>
        <div id="modal-root" class="fixed inset-0 z-50 pointer-events-none"></div>
        <!-- Sistema de Notificaciones Moderno -->
        <div id="notification-container" class="notification-container"></div>    </div><script src="js/utils/security.js"></script>
    <script src="js/utils/input-validation.js"></script>
    <script type="module">
        // ===============================================
        // 🌌 NEBULA FINANCIAL APP - CONFIGURACIÓN CORE
        // ===============================================        // 🔒 INICIALIZAR SISTEMA DE SEGURIDAD
        if (typeof NebulaSecurityUtils !== 'undefined') {
            NebulaSecurityUtils.init();
            console.log('🔒 Sistema de seguridad Nebula inicializado');
        }
        
        // 🔒 INICIALIZAR VALIDADOR DE ENTRADA
        if (typeof NebulaInputValidator !== 'undefined') {
            console.log('🔒 Sistema de validación de entrada inicializado');
        }        // 🚨 TIMESTAMP DEBUG: Asegurar recarga fresca
        console.log('🕐 TIMESTAMP CARGA:', new Date().toISOString(), 'Cache-bust activo');
        console.log('🔄 VERSION CÓDIGO:', 'v2.1_FIXED_DEFINITIVO_' + Date.now());
        console.log('🚀 INICIANDO DEBUG TOTAL - TODAS LAS FUNCIONES REVISADAS');
        // 🎯 SHORTCUT SYSTEM STATUS se verificará después de la declaración
        
        // 🔒 FUNCIONES DE SEGURIDAD - Protección XSS
        /**
         * Sanitiza strings para prevenir ataques XSS
         * @param {string} str - String a sanitizar
         * @returns {string} String sanitizado
         */
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Sanitiza objetos con propiedades de texto
         * @param {object} obj - Objeto a sanitizar
         * @returns {object} Objeto sanitizado
         */
        function sanitizeObject(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const sanitized = {};
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string') {
                    sanitized[key] = sanitizeHTML(value);
                } else if (typeof value === 'object') {
                    sanitized[key] = sanitizeObject(value);
                } else {
                    sanitized[key] = value;
                }
            }
            return sanitized;
        }

        /**
         * Establece innerHTML de forma segura
         * @param {Element} element - Elemento DOM
         * @param {string} html - HTML a insertar (será sanitizado si contiene entrada de usuario)
         * @param {boolean} trusted - Si el HTML viene de código confiable (default: true)
         */
        function safeSetInnerHTML(element, html, trusted = true) {
            if (!element) return;
            if (trusted) {
                element.innerHTML = html; // HTML confiable del código de la app
            } else {
                element.textContent = html; // Entrada de usuario - solo texto
            }
        }

        /**
         * 🎨 DEFINICIÓN DE TEMAS VISUALES
         * Cada tema define colores, gradientes y efectos de partículas únicos
         * Todos centrados alrededor del SOL como estrella principal de la aplicación
         */
        const THEMES = {            aureoAmanecer: { 
                name: 'Áureo Amanecer', 
                gradient: 'radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffd700\' fill-opacity=\'0.1\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-amber-300', 
                accentBg: 'bg-amber-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,191,36,0.8)]', 
                accentColor: '#FCD34D', 
                accentBorder: 'border-amber-300', 
                accentRing: 'focus:ring-amber-300', 
                positive: 'text-emerald-300', 
                negative: 'text-rose-300', 
                surface: 'bg-black/20 border-amber-200/30 backdrop-blur-md', 
                textPrimary: 'text-amber-50', 
                textSecondary: 'text-amber-200/80', 
                particleType: 'goldenDust',
                sunColor: '#FFD700'
            },            crisonVespertino: { 
                name: 'Crisón Vespertino', 
                gradient: 'radial-gradient(ellipse at center, #2d1b3d 0%, #4a1942 40%, #1a0f1a 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ff6b9d\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-rose-300', 
                accentBg: 'bg-rose-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,113,133,0.8)]', 
                accentColor: '#FB7185', 
                accentBorder: 'border-rose-300', 
                accentRing: 'focus:ring-rose-300', 
                positive: 'text-teal-300', 
                negative: 'text-orange-300', 
                surface: 'bg-black/20 border-rose-200/30 backdrop-blur-md', 
                textPrimary: 'text-rose-50', 
                textSecondary: 'text-rose-200/80', 
                particleType: 'crimsonMist',
                sunColor: '#FF4C6A'
            },            aguamarinaCeleste: { 
                name: 'Aguamarina Celeste', 
                gradient: 'radial-gradient(ellipse at center, #0f2027 0%, #203a43 40%, #0c1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%2367e8f9\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-cyan-300', 
                accentBg: 'bg-cyan-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(103,232,249,0.8)]', 
                accentColor: '#67E8F9', 
                accentBorder: 'border-cyan-300', 
                accentRing: 'focus:ring-cyan-300', 
                positive: 'text-lime-300', 
                negative: 'text-amber-300', 
                surface: 'bg-black/20 border-cyan-200/30 backdrop-blur-md', 
                textPrimary: 'text-cyan-50', 
                textSecondary: 'text-cyan-200/80', 
                particleType: 'aquaFlow',
                sunColor: '#00CED1'
            },            violetaReal: { 
                name: 'Violeta Real', 
                gradient: 'radial-gradient(ellipse at center, #1e1b4b 0%, #312e81 40%, #111827 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23a855f7\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-purple-300', 
                accentBg: 'bg-purple-500', 
                accentGlow: 'shadow-[0_0_25px_rgba(168,85,247,0.8)]', 
                accentColor: '#A855F7', 
                accentBorder: 'border-purple-300', 
                accentRing: 'focus:ring-purple-300', 
                positive: 'text-green-300', 
                negative: 'text-red-300', 
                surface: 'bg-black/20 border-purple-200/30 backdrop-blur-md', 
                textPrimary: 'text-purple-50', 
                textSecondary: 'text-purple-200/80', 
                particleType: 'royalAura',
                sunColor: '#8B5CF6'
            }
        };/**
         * 🎯 ICONOS SVG VECTORIALES
         * Conjunto de iconos optimizados para la interfaz
         */
        const ICONS = {            dashboard: `<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/>`,
            income: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4-4 4 4"/><path d="M12 8v8"/>`,
            expenses: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/>`,
            goals: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1"/>`,
            investments: `<path d="M3 3v18h18"/><path d="m4 14 4-4 4 4 6-6"/>`,
            debts: `<rect x="1" y="4" width="22" height="16" rx="3" ry="3"/><line x1="1" y1="10" x2="23" y2="10"/>`,
            achievements: `<path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>`,
            settings: `<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`,
            plus: `<path d="M12 5v14m-7-7h14" />`,
            trash: `<path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>`,
            eye: `<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>`,
            eyeOff: `<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 11 8 11 8a18.35 18.35 0 0 1-2.18 3.2M3.5 12a10.43 10.43 0 0 1 2.22-3.2"/><path d="M1 1l22 22"/>`,
            chevronLeft: `<path d="m15 18-6-6 6-6"/>`,
            chevronRight: `<path d="m9 18 6-6-6-6"/>`,
            history: `<path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>`,
            mail: `<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>`,
            zap: `<path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>`,
            x: `<path d="M18 6 6 18M6 6l12 12"/>`,
            // Nuevos iconos para notificaciones y calendario
            calendar: `<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>`,
            check: `<polyline points="20 6 9 17 4 12"/>`,
            alertCircle: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/>`,
            info: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/>`,
            alertTriangle: `<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/>`,
            repeat: `<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
            copy: `<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>`
        };
        
        /**
         * 📂 CATEGORÍAS DE GASTOS DISPONIBLES
         * Lista predefinida para categorización de transacciones
         */
        const CATEGORIES = ['Comida', 'Transporte', 'Ocio', 'Hogar', 'Salud', 'Educación', 'Regalos', 'Varios'];        // ===============================================
        // 🔔 SISTEMA DE NOTIFICACIONES MODERNO
        // ===============================================
        
        /**
         * 📢 Gestor de Notificaciones
         * Sistema completo para mostrar mensajes al usuario de forma no invasiva
         */
        const NotificationSystem = {
            container: null,
            
            init() {
                this.container = document.getElementById('notification-container');
            },
            
            /**
             * Muestra una notificación
             * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
             * @param {string} title - Título de la notificación
             * @param {string} message - Mensaje descriptivo
             * @param {number} duration - Duración en ms (default: 4000)
             */
            show(type = 'info', title = '', message = '', duration = 4000) {
                if (!this.container) this.init();
                
                const id = Date.now().toString();
                const iconMap = {
                    success: ICONS.check,
                    error: ICONS.alertCircle,
                    warning: ICONS.alertTriangle,
                    info: ICONS.info
                };
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                  notification.innerHTML = `
                    <button class="notification-close" onclick="NotificationSystem.remove('${id}')" aria-label="Cerrar notificación" role="button">
                        ${createIcon(ICONS.x, 'w-4 h-4')}
                    </button>
                    <div class="notification-header">
                        ${createIcon(iconMap[type] || iconMap.info, 'w-5 h-5')}
                        <span>${title}</span>
                    </div>
                    <div class="notification-body">${message}</div>
                `;
                
                this.container.appendChild(notification);
                
                // Trigger animation
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });
                
                // Auto remove
                if (duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }
                
                return id;
            },
            
            remove(id) {
                const notification = document.getElementById(`notification-${id}`);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }
            },
            
            // Métodos convenientes
            success(title, message, duration) {
                return this.show('success', title, message, duration);
            },
            
            error(title, message, duration) {
                return this.show('error', title, message, duration);
            },
            
            warning(title, message, duration) {
                return this.show('warning', title, message, duration);
            },
            
            info(title, message, duration) {
                return this.show('info', title, message, duration);
            }
        };
        
        /**
         * 🎮 GESTOR CENTRAL DEL ESTADO
         * Maneja toda la lógica de negocio y persistencia de datos
         */
        const appState = {
            // --- Estado de Usuario y Sesión ---
            user: JSON.parse(sessionStorage.getItem('financialUser')) || null,
            isLoading: false,
            activeView: 'dashboard',
            activeModal: null,
              // --- Configuración y Preferencias ---
            isPrivate: (() => {
                try {
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('isPrivateMode', true) :
                        JSON.parse(localStorage.getItem('isPrivateMode')) ?? true;
                } catch { return true; }
            })(),
            themeKey: (() => {
                try {
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('financialTheme', 'aureoAmanecer') :
                        localStorage.getItem('financialTheme') || 'aureoAmanecer';
                } catch { return 'aureoAmanecer'; }
            })(),
            
            // --- Estado Temporal de Navegación ---
            currentDate: new Date(),
            calendarViewYear: new Date().getFullYear(),
              // --- Datos Financieros Principales ---
            data: (() => {
                try {
                    const defaultData = { transactions: {}, goals: [], investments: [], debts: [] };
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('financialData', defaultData) :
                        JSON.parse(localStorage.getItem('financialData')) || defaultData;
                } catch { 
                    return { transactions: {}, goals: [], investments: [], debts: [] }; 
                }
            })(),
            
            // --- Getters Computados ---
            get theme() { 
                return THEMES[this.themeKey]; 
            },
            
            get currentMonthKey() { 
                return `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}`; 
            },
              // --- Persistencia de Datos ---
            saveState() {
                try {
                    if (NebulaSecurityUtils) {
                        // Usar almacenamiento seguro cifrado
                        NebulaSecurityUtils.secureSetItem('financialTheme', this.themeKey);
                        NebulaSecurityUtils.secureSetItem('financialData', this.data);
                        NebulaSecurityUtils.secureSetItem('isPrivateMode', this.isPrivate);
                        console.log('🔒 Estado guardado de forma segura');
                    } else {
                        // Fallback a localStorage normal
                        localStorage.setItem('financialTheme', this.themeKey);
                        localStorage.setItem('financialData', JSON.stringify(this.data));
                        localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                        console.log('⚠️ Estado guardado sin cifrado (fallback)');
                    }
                } catch (error) {
                    console.error('❌ Error guardando estado:', error);
                    // Último recurso: localStorage directo
                    localStorage.setItem('financialTheme', this.themeKey);
                    localStorage.setItem('financialData', JSON.stringify(this.data));
                    localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                }
            },
            
            // --- Autenticación ---
            login(method) {
                this.isLoading = true; 
                renderApp(); 
                setTimeout(() => {
                    this.user = { name: method === 'google' ? 'Usuario de Correo' : 'Invitado'};
                    sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                    this.isLoading = false;
                    renderApp(); 
                }, 1500);
            },
            
            // --- Configuración Visual ---
            setTheme(key) { 
                this.themeKey = key; 
                this.saveState(); 
                renderApp(); 
            },
            
            setView(view) { 
                this.activeView = view; 
                renderApp(); 
            },
            
            togglePrivacy() { 
                this.isPrivate = !this.isPrivate; 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Navegación Temporal ---
            changeMonth(direction) { 
                this.currentDate.setMonth(this.currentDate.getMonth() + direction); 
                renderApp(); 
            },
            
            setCalendarDate(monthIndex) {
                this.currentDate = new Date(this.calendarViewYear, monthIndex, 1);
                this.closeModal(true);
            },
            
            // --- Gestión de Modales ---
            openModal(modalType) {
                if (modalType === 'calendar') {
                    this.calendarViewYear = this.currentDate.getFullYear();
                }
                this.activeModal = modalType;
                renderModal();
            },
            
            closeModal(shouldRenderAppAfter = false) {
                const modalContainer = document.querySelector('.modal-container');
                if (modalContainer) {
                    modalContainer.classList.remove('modal-enter');
                    modalContainer.classList.add('modal-leave');
                    modalContainer.addEventListener('animationend', () => {
                        this.activeModal = null;
                        renderModal(); 
                        if (shouldRenderAppAfter) renderApp();
                    }, { once: true });
                } else {
                     this.activeModal = null;
                     if (shouldRenderAppAfter) renderApp();
                }
            },
            
            // --- Navegación de Calendario ---
            changeCalendarYear(direction) { 
                this.calendarViewYear += direction; 
                renderModal(); 
            },
            
            setCalendarYear(year) { 
                if(year > 1900 && year < 2200) this.calendarViewYear = year; 
                renderModal();
            },
            
            goToday() { 
                this.currentDate = new Date(); 
                this.calendarViewYear = this.currentDate.getFullYear(); 
                this.closeModal(true);
            },            // --- Gestión de Transacciones ---
            addTransaction(t) {
                const key = this.currentMonthKey;
                if (!this.data.transactions[key]) this.data.transactions[key] = [];
                this.data.transactions[key].push({ 
                    ...t, 
                    id: Date.now(), 
                    date: new Date().toISOString() 
                });
                this.saveState();
                renderApp();
            },
            
            deleteTransaction(id) {
                const key = this.currentMonthKey;
                if(this.data.transactions[key]) {
                    this.data.transactions[key] = this.data.transactions[key].filter(t => t.id !== id);
                    this.saveState();
                    renderApp();
                }
            },
              repeatPreviousMonth(type) {
                const prevDate = new Date(this.currentDate);
                prevDate.setMonth(prevDate.getMonth() - 1);
                const prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
                const prevTransactions = this.data.transactions[prevKey] || [];
                const transactionsToCopy = prevTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length > 0) {
                    transactionsToCopy.forEach(t => this.addTransaction({ 
                        ...t, 
                        date: new Date().toISOString() 
                    }));
                    NotificationSystem.success('Éxito', 
                        `Se copiaron ${transactionsToCopy.length} transacciones del mes anterior`);
                } else {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones del mes anterior para copiar');
                }
            },
            
            /**
             * 📅 Repite transacciones actuales hasta fin de año
             * @param {string} type - Tipo de transacción ('income' o 'expense')
             */
            repeatYearlyFromCurrent(type) {
                const currentTransactions = this.data.transactions[this.currentMonthKey] || [];
                const transactionsToCopy = currentTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length === 0) {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones en el mes actual para copiar');
                    return;
                }
                
                const currentYear = this.currentDate.getFullYear();
                const currentMonth = this.currentDate.getMonth();
                let totalCopied = 0;
                
                // Copiar a todos los meses restantes del año
                for (let month = currentMonth + 1; month < 12; month++) {
                    const targetKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                    
                    if (!this.data.transactions[targetKey]) {
                        this.data.transactions[targetKey] = [];
                    }
                    
                    transactionsToCopy.forEach(t => {
                        const newTransaction = {
                            ...t,
                            id: Date.now() + Math.random(), // ID único
                            date: new Date(currentYear, month, new Date(t.date).getDate()).toISOString()
                        };
                        this.data.transactions[targetKey].push(newTransaction);
                        totalCopied++;
                    });
                }
                
                if (totalCopied > 0) {
                    this.saveState();
                    NotificationSystem.success('Éxito', 
                        `Se copiaron ${totalCopied} transacciones hasta fin de año`);
                } else {
                    NotificationSystem.info('Sin cambios', 
                        'Ya es diciembre o no hay meses restantes');
                }
            },
            
            // --- Gestión de Metas ---
            addGoal(g) { 
                this.data.goals.push({ 
                    ...g, 
                    id: Date.now(), 
                    saved: 0 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteGoal(id) { 
                this.data.goals = this.data.goals.filter(goal => goal.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Gestión de Inversiones ---
            addInvestment(i) { 
                this.data.investments.push({ 
                    ...i, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteInvestment(id) { 
                this.data.investments = this.data.investments.filter(inv => inv.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            updateInvestment(id, newAmount) {
                const investment = this.data.investments.find(inv => inv.id === id);
                if (investment) investment.currentAmount = newAmount;
                this.saveState();
                if(this.activeView === 'investments') {
                    document.querySelector('#content-root > main').innerHTML = renderInvestmentsView();
                }
            },
            
            // --- Gestión de Deudas ---
            addDebt(d) { 
                this.data.debts.push({ 
                    ...d, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteDebt(id) { 
                this.data.debts = this.data.debts.filter(debt => debt.id !== id); 
                this.saveState(); 
                renderApp(); 
            }
        };        // ===============================================
        // 🔧 UTILIDADES Y FUNCIONES AUXILIARES
        // ===============================================
        
        /**
         * 💰 Formatea números con separadores de miles (formato chileno)
         * @param {string|number} value - Valor a formatear
         * @returns {string} Número formateado con puntos
         */
        const formatNumberWithDots = (value) => {
            if (!value && value !== 0) return '';
            return Number(String(value).replace(/\D/g, '')).toLocaleString('es-CL');
        };
        
        /**
         * 🔢 Convierte número formateado a número plano
         * @param {string} value - Valor formateado con puntos
         * @returns {number} Número sin formato
         */
        const parseFormattedNumber = (value) => parseFloat(String(value).replace(/\./g, '')) || 0;
        
        /**
         * 💵 Formatea valor como moneda
         * @param {number} value - Valor numérico
         * @returns {string} Valor formateado como moneda
         */
        const formatCurrency = (value) => value != null ? `$${formatNumberWithDots(value)}` : '$0';
        
        /**
         * 🎨 Crea elemento SVG de icono
         * @param {string} path - Path del icono SVG
         * @param {string} className - Clases CSS adicionales
         * @returns {string} HTML del icono SVG
         */
        const createIcon = (path, className = "w-6 h-6") => 
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;

        // ===============================================
        // 🏗️ REFERENCIAS DOM PRINCIPALES        // ===============================================
        // 🎯 REFERENCIAS A ELEMENTOS DEL DOM (se inicializan más tarde)
        // ===============================================
        
        let contentRoot, dockRoot, parallaxBg, modalRoot;// ===============================================
        // 🖼️ FUNCIONES DE RENDERIZADO PRINCIPAL
        // ===============================================
          /**
         * 🎯 RENDERIZADOR PRINCIPAL DE LA APLICACIÓN
         * Controla el flujo de renderizado según el estado actual
         */
        function renderApp() {
            // Aplicar tema visual
            document.body.style.setProperty('--bg-gradient', appState.theme.gradient);
            parallaxBg.innerHTML = renderParallaxBackground();
            
            if (appState.isLoading) {
                contentRoot.innerHTML = renderLoadingScreen();
                dockRoot.innerHTML = '';
            } else if (!appState.user) {
                contentRoot.innerHTML = renderLoginView();
                dockRoot.innerHTML = '';
            } else {
                let viewHTML = '';
                
                // Agregar selector de mes para vistas que lo requieren
                if(!['settings', 'achievements', 'goals', 'investments', 'debts'].includes(appState.activeView)) {
                   viewHTML += renderMonthSelector();
                }

                // Renderizar vista según selección activa
                switch (appState.activeView) {
                    case 'dashboard': 
                        viewHTML += renderDashboard(); 
                        break;
                    case 'income': 
                        viewHTML += renderTransactionsView('income'); 
                        break;
                    case 'expenses': 
                        viewHTML += renderTransactionsView('expense'); 
                        break;
                    case 'goals': 
                        viewHTML += renderGoalsView(); 
                        break;
                    case 'investments': 
                        viewHTML += renderInvestmentsView(); 
                        break;
                    case 'debts': 
                        viewHTML += renderDebtsView(); 
                        break;
                    case 'settings': 
                        viewHTML += renderSettingsView(); 
                        break;
                    default: 
                        viewHTML += renderComingSoon(appState.activeView);
                }
                
                contentRoot.innerHTML = `<main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto w-full view-transition">${viewHTML}</main>`;
                dockRoot.innerHTML = renderDock();
            }
            
            addEventListeners();
            
            // Actualizar glider después del renderizado
            setTimeout(() => updateDockGlider(), 100);
        }
          // ===============================================
        // 🎭 FUNCIONES DE RENDERIZADO DE VISTAS ESPECIALES
        // ===============================================
        
        /**
         * 🔐 Vista de Login/Autenticación
         */
        function renderLoginView() {
            return `
                <div class="flex flex-col items-center justify-center h-screen login-card p-4">
                    <div class="backdrop-blur-md rounded-2xl shadow-lg p-8 ${appState.theme.surface} text-center w-full max-w-sm">
                        <h1 class="text-4xl font-black ${appState.theme.accent}">Nebula</h1>
                        <p class="mt-2 ${appState.theme.textSecondary}">Tu universo financiero personal.</p>
                        <div class="mt-8 space-y-4">
                            <button data-login-method="google" class="login-button w-full flex items-center justify-center gap-3 bg-white/90 text-slate-800 font-bold py-3 px-4 rounded-lg hover:bg-white transition-transform transform hover:scale-105">
                                ${createIcon(ICONS.mail, 'w-6 h-6')}
                                Ingresar con Correo
                            </button>
                            <button data-login-method="guest" class="login-button w-full bg-white/20 text-white font-bold py-3 px-4 rounded-lg hover:bg-white/30 transition-transform transform hover:scale-105">
                                Entrar como Invitado
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * ⏳ Pantalla de Carga con Animación Orbital
         */
        function renderLoadingScreen() {
            return `
                <div class="fixed inset-0 flex flex-col items-center justify-center text-white z-50">
                    <div class="w-64 h-64 relative mb-8">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-yellow-400 rounded-full ${appState.theme.accentGlow}"></div>
                        <div class="absolute inset-0 animate-[spin_20s_linear_infinite]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-4 h-4 bg-red-500 rounded-full"></div>
                        </div>
                        <div class="absolute inset-4 animate-[spin_30s_linear_infinite_reverse]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-6 bg-blue-500 rounded-full"></div>
                        </div>
                        <div class="absolute inset-10 animate-[spin_45s_linear_infinite]">
                            <div class="absolute bottom-0 right-1/2 translate-x-1/2 w-5 h-5 bg-green-500 rounded-full"></div>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-white mb-2">Alineando las estrellas...</h1>
                    <p class="${appState.theme.textSecondary}">Cargando tu universo financiero.</p>
                </div>
            `;
        }
          /**
         * 📅 Selector de Mes con Calendario Desplegable
         */        function renderMonthSelector() {
            const today = new Date();
            const currentDate = appState.currentDate;
            const monthName = currentDate.toLocaleString('es-ES', { month: 'long' });
            const year = currentDate.getFullYear();
            
            // Determinar si es pasado, presente o futuro
            let timeLabel = '';
            if (currentDate.getFullYear() < today.getFullYear() || 
                (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() < today.getMonth())) {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full bg-amber-500/20 text-amber-300 font-medium backdrop-blur-sm border border-amber-400/30">✨ PASADO</span>`;
            } else if (currentDate.getFullYear() > today.getFullYear() || 
                      (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() > today.getMonth())) {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full bg-cyan-500/20 text-cyan-300 font-medium backdrop-blur-sm border border-cyan-400/30">🚀 FUTURO</span>`;
            } else {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full ${appState.theme.accentBg}/20 ${appState.theme.accent} font-medium backdrop-blur-sm border ${appState.theme.accentBorder}/30">🌟 ACTUAL</span>`;
            }
            
            return `
                <div class="text-center mb-8 relative">
                    <!-- Título principal centrado con efectos -->
                    <div class="flex flex-col items-center gap-3 mb-6">
                        <h1 class="text-3xl sm:text-4xl font-black ${appState.theme.textPrimary} capitalize relative">
                            <span class="relative z-10 bg-gradient-to-r from-${appState.theme.accent.replace('text-', '')} to-${appState.theme.accent.replace('text-', '')} bg-clip-text text-transparent filter drop-shadow-lg">
                                ${monthName} ${year}
                            </span>
                            <!-- Efecto de brillo sutil -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent blur-sm opacity-30 animate-pulse"></div>
                            <!-- Sombra de resplandor -->
                            <div class="absolute inset-0 ${appState.theme.accentGlow} opacity-20 blur-lg"></div>
                        </h1>
                        ${timeLabel}
                    </div>
                    
                    <!-- Controles de navegación centrados -->
                    <div class="flex items-center justify-center gap-4">                        <button id="month-prev" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Mes anterior (←)" aria-label="Ir al mes anterior" role="button">
                            ${createIcon(ICONS.chevronLeft, "w-6 h-6")}
                        </button>
                        
                        <div class="relative">
                            <button id="calendar-dropdown-button" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Seleccionar mes (C)" aria-label="Abrir selector de mes" role="button" aria-haspopup="true" aria-expanded="false">
                                ${createIcon(ICONS.calendar, "w-6 h-6")}
                            </button>
                            
                            <div id="calendar-dropdown" class="hidden absolute left-1/2 transform -translate-x-1/2 top-14 z-50 backdrop-blur-md rounded-xl shadow-lg p-4 ${appState.theme.surface} w-64">
                                <div class="grid grid-cols-3 gap-2">
                                    ${Array.from({length: 12}, (_, i) => {
                                        const monthKey = `${year}-${String(i + 1).padStart(2, '0')}`;
                                        const hasData = appState.data.transactions[monthKey] && 
                                                       Object.values(appState.data.transactions[monthKey]).length > 0;
                                        const isCurrentMonth = i === currentDate.getMonth();
                                        const isToday = i === today.getMonth() && year === today.getFullYear();
                                        
                                        let classes = 'month-dropdown-item p-2 rounded-lg text-sm font-medium transition-all hover:bg-black/10 cursor-pointer text-center backdrop-blur-sm';
                                        
                                        if (isCurrentMonth) {
                                            classes += ` ring-2 ${appState.theme.accentRing} ${appState.theme.accent} ${appState.theme.accentGlow}`;
                                        } else if (isToday) {
                                            classes += ` ${appState.theme.accentBg} text-slate-900`;
                                        } else if (hasData) {
                                            classes += ` bg-black/20 ${appState.theme.textPrimary} backdrop-blur-md`;
                                        } else {
                                            classes += ` ${appState.theme.textSecondary}`;
                                        }
                                        
                                        return `<div class="${classes}" data-month="${i}">${new Date(year, i).toLocaleString('es-ES', {month: 'short'})}</div>`;
                                    }).join('')}
                                </div>
                                
                                <div class="mt-4 pt-3 border-t border-white/10 flex justify-between items-center">
                                    <button id="today-shortcut" class="text-xs ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-2 py-1 rounded">
                                        🏠 Ir a hoy
                                    </button>
                                    <div class="flex items-center gap-2 text-xs ${appState.theme.textSecondary}">
                                        <span class="w-2 h-2 rounded-full ${appState.theme.accentBg}"></span>Hoy
                                        <span class="w-2 h-2 rounded-full bg-white/20"></span>Con datos
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="month-next" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Mes siguiente (→)">
                            ${createIcon(ICONS.chevronRight, "w-6 h-6")}
                        </button>
                    </div>
                </div>
            `;
        }
          // ===============================================
        // 🪟 SISTEMA DE MODALES
        // ===============================================
        
        /**
         * 🎭 Renderizador Principal de Modales
         * Controla qué modal mostrar según el estado activo
         */
        function renderModal() {
            modalRoot.innerHTML = '';
            
            if (appState.activeModal === 'calendar') {
                modalRoot.innerHTML = renderCalendarModal();
            } else if (appState.activeModal === 'shortcuts') {
                modalRoot.innerHTML = renderShortcutsModal();
            }
            
            if (appState.activeModal) {
                addModalEventListeners();
            }
        }

        /**
         * 📅 Modal de Calendario con Navegación Anual
         */
        function renderCalendarModal() {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const today = new Date();
            const currentSelectedDate = appState.currentDate;

            const monthsHTML = months.map((month, index) => {
                const monthKey = `${appState.calendarViewYear}-${String(index + 1).padStart(2, '0')}`;
                let monthClass = 'bg-black/20 backdrop-blur-sm';
                
                // Indicador visual para meses con datos
                if (appState.data.transactions[monthKey] && Object.values(appState.data.transactions[monthKey]).length > 0) {
                    const density = Math.min(Object.values(appState.data.transactions[monthKey]).length / 10, 1);
                    monthClass = `bg-black/30 opacity-${Math.floor(density * 10) * 10 + 30} backdrop-blur-md`;
                }
                
                // Destacar mes seleccionado actualmente
                if(appState.calendarViewYear === currentSelectedDate.getFullYear() && index === currentSelectedDate.getMonth()) {
                     monthClass += ` ring-2 ${appState.theme.accentRing}`;
                }
                
                // Destacar mes actual
                if(appState.calendarViewYear === today.getFullYear() && index === today.getMonth()) {
                    monthClass = `${appState.theme.accentBg} text-slate-900`;
                }
                
                return `<button data-month-index="${index}" class="month-button p-4 rounded-lg text-lg font-semibold transition-transform duration-200 hover:scale-110 ${monthClass}" title="${new Date(appState.calendarViewYear, index).toLocaleString('es-ES', {month:'long'})}">${month}</button>`;
            }).join('');
            
            return `
                <div class="modal-container fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm modal-enter p-4">
                    <div class="modal-content relative backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} w-full max-w-md mx-4">
                        <button class="modal-close-button absolute top-3 right-3 p-2 ${appState.theme.textSecondary} hover:${appState.theme.accent} rounded-full">
                            ${createIcon(ICONS.x, 'w-6 h-6')}
                        </button>
                        
                        <div class="flex items-center justify-between mb-6">
                            <button id="calendar-year-prev" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-2 rounded-full">
                                ${createIcon(ICONS.chevronLeft, "w-8 h-8")}
                            </button>
                            <input type="number" id="calendar-year-input" value="${appState.calendarViewYear}" class="text-2xl font-bold ${appState.theme.textPrimary} bg-transparent w-24 text-center focus:outline-none focus:bg-black/20 rounded-lg backdrop-blur-md" aria-label="Año del calendario" min="1900" max="2100">
                            <button id="calendar-year-next" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-2 rounded-full">
                                ${createIcon(ICONS.chevronRight, "w-8 h-8")}
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-4 text-center">${monthsHTML}</div>
                        
                        <div class="flex items-center justify-between mt-6">
                            <button id="today-button" class="py-2 px-4 rounded-lg ${appState.theme.textSecondary} hover:${appState.theme.accent} font-bold text-sm">
                                Volver a Hoy
                            </button>
                            <div class="flex items-center gap-4 text-xs ${appState.theme.textSecondary}">
                               <div class="flex items-center gap-1">
                                   <span class="w-3 h-3 rounded-full ${appState.theme.accentBg}"></span>Actual
                               </div>
                               <div class="flex items-center gap-1">
                                   <span class="w-3 h-3 rounded-full bg-white/20"></span>Con Datos
                               </div>
                            </div>
                       </div>
                    </div>
                </div>
            `;
        }
          /**
         * ⌨️ Modal de Atajos de Teclado Actualizado
         */
        function renderShortcutsModal() {
            const shortcutsList = ShortcutSystem.getShortcutsList();
            
            const shortcutsHTML = shortcutsList.map(s => `
                <li class="flex justify-between items-center p-3 bg-black/20 rounded-lg backdrop-blur-md">
                    <span class="${appState.theme.textSecondary}">${s.description}</span>
                    <kbd class="px-3 py-1.5 text-sm font-semibold ${appState.theme.textPrimary} ${appState.theme.surface} border ${appState.theme.accentBorder} rounded-md">${s.key}</kbd>
                </li>
            `).join('');

            return `
                 <div class="modal-container fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm modal-enter p-4">
                    <div class="modal-content relative backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
                        <button class="modal-close-button absolute top-3 right-3 p-2 ${appState.theme.textSecondary} hover:${appState.theme.accent} rounded-full">
                            ${createIcon(ICONS.x, 'w-6 h-6')}
                        </button>
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">Atajos de Teclado</h2>
                        <ul class="space-y-3">${shortcutsHTML}</ul>
                        
                        <div class="mt-6 pt-4 border-t border-white/10">
                            <p class="text-xs ${appState.theme.textSecondary} text-center">
                                Los atajos no funcionan cuando estás escribiendo en campos de texto.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }// ===============================================
        // 📊 VISTAS PRINCIPALES DE LA APLICACIÓN
        // ===============================================
        
        /**
         * 🏠 Vista Principal del Dashboard
         * Muestra resumen financiero con orbe central interactivo
         */
        function renderDashboard() {
            const { balance, netWorth } = calculateSummary();
            const firstGoal = appState.data.goals[0];
            let monthsToGoal = "Sin metas";
            
            if(firstGoal) {
                const allTransactions = Object.values(appState.data.transactions).flat();
                const globalIncome = allTransactions.filter(t=>t.type==='income').reduce((sum,t)=>sum+t.amount,0);
                const globalExpenses = allTransactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+t.amount,0);
                const firstDate = allTransactions.length > 0 ? new Date(allTransactions.reduce((min, t) => Math.min(min, new Date(t.date).getTime()), Date.now())) : new Date();
                const monthsDiff = Math.max(1, (new Date().getFullYear() - firstDate.getFullYear()) * 12 + (new Date().getMonth() - firstDate.getMonth()) + 1);
                const monthlySavings = (globalIncome-globalExpenses)/monthsDiff;
                monthsToGoal = monthlySavings > 0 ? `${Math.ceil((firstGoal.target - firstGoal.saved)/monthlySavings)} meses` : '∞';
            }

            const infoHTML = appState.isPrivate ? `
                <div class="flex flex-col items-center justify-center text-slate-900/70 backdrop-blur-sm p-10 rounded-full cursor-pointer" id="privacy-toggle">
                    ${createIcon(ICONS.eyeOff, "w-20 h-20")}
                    <p class="font-semibold mt-2">Información Oculta</p>
                </div>
            ` : `
                <div class="flex flex-col items-center justify-center text-slate-900 w-full h-full">
                    <div class="relative mb-4">
                        <div class="flex items-center gap-2">
                            <p class="text-sm font-medium opacity-70">Patrimonio Neto</p>                            <button id="privacy-toggle" class="text-slate-900/50 hover:text-slate-900 transition-colors" title="Ocultar información" aria-label="Alternar modo privacidad" aria-pressed="${appState.privacyMode}" role="button">
                                ${createIcon(ICONS.eye, "w-5 h-5")}
                            </button>
                        </div>
                        <p class="text-4xl font-bold">${formatCurrency(netWorth)}</p>
                    </div>
                    <div class="flex justify-around w-full text-sm">
                        <div>
                            <p class="font-medium opacity-70">Balance (Mes)</p>
                            <p class="font-semibold text-lg">${formatCurrency(balance)}</p>
                        </div>
                        <div class="border-l border-slate-900/30"></div>
                        <div>
                            <p class="font-medium opacity-70">Próxima Meta</p>
                            <p class="font-semibold text-lg">${monthsToGoal}</p>
                        </div>
                    </div>
                </div>
            `;            return `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-250px)] relative">
                    <div class="w-80 h-80 sm:w-96 sm:h-96 rounded-full flex items-center justify-center text-center transition-all duration-500" 
                         style="background: radial-gradient(circle at 30% 30%, ${appState.theme.sunColor || appState.theme.accentColor}, ${appState.theme.accentColor}aa 60%, ${appState.theme.accentColor}44 100%); 
                                box-shadow: 0 0 40px 10px ${appState.theme.sunColor || appState.theme.accentColor}60, 
                                           0 0 80px 30px ${appState.theme.sunColor || appState.theme.accentColor}30, 
                                           0 0 120px 50px ${appState.theme.sunColor || appState.theme.accentColor}20,
                                           inset 0 0 30px ${appState.theme.sunColor || appState.theme.accentColor}20;">
                        ${infoHTML}
                    </div>
                    
                    <!-- Rayos de sol sutiles -->
                    <div class="absolute inset-0 pointer-events-none">
                        ${Array.from({length: 8}, (_, i) => `
                            <div class="absolute w-1 h-20 origin-bottom animate-pulse" 
                                 style="background: linear-gradient(to top, ${appState.theme.sunColor || appState.theme.accentColor}20, transparent);
                                        left: 50%; top: 50%; 
                                        transform: translate(-50%, -100%) rotate(${i * 45}deg);
                                        animation-delay: ${i * 0.2}s;
                                        opacity: 0.6;">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }        /**
         * 💰 Vista de Gestión de Transacciones (Ingresos/Gastos)
         * @param {string} type - Tipo de transacción ('income' o 'expense')
         */
        function renderTransactionsView(type) {
            const title = type === 'income' ? 'Ingresos' : 'Gastos';
            const isExpense = type === 'expense';
            const currentMonthTransactions = appState.data.transactions[appState.currentMonthKey] || [];
              // Renderizar lista de transacciones del mes actual
            const transactionsHTML = currentMonthTransactions
                .filter(t => t.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => `
                    <li class="${appState.theme.surface} p-4 rounded-lg flex justify-between items-center transition-all hover:bg-black/10 backdrop-blur-sm">
                        <div>
                            <p class="font-semibold ${appState.theme.textPrimary}">${t.description}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${ isExpense && t.category ? `<p class="text-xs font-medium px-2 py-0.5 rounded-full" style="background-color:${appState.theme.accentColor}30; color:${appState.theme.accentColor}">${t.category}</p>` : '' }
                                <p class="text-xs ${appState.theme.textSecondary}">${new Date(t.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <p class="font-bold text-lg ${type === 'income' ? appState.theme.positive : appState.theme.negative}">
                                ${formatCurrency(t.amount)}
                            </p>
                            <button class="delete-transaction-button text-red-500/70 hover:text-red-500 transition-colors" data-transaction-id="${t.id}" title="Eliminar transacción">
                                ${createIcon(ICONS.trash, 'w-5 h-5')}
                            </button>
                        </div>
                    </li>
                `).join('');

            // Opciones de categorías para gastos
            const categoryOptionsHTML = CATEGORIES.map(cat => 
                `<option class="bg-slate-800" value="${cat}">${cat}</option>`
            ).join('');
              // Campo de categoría (solo para gastos)
            const categoryFieldHTML = isExpense ? `
                <div>
                    <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Categoría</label>
                    <select name="category" class="w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" required>
                        ${categoryOptionsHTML}
                    </select>
                </div>
            ` : '';return `
                <div class="${appState.theme.surface} rounded-2xl shadow-lg p-6">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">💰 Gestión de ${title}</h2>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="repeat-month-button" data-type="${type}" class="flex items-center gap-2 text-sm ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-3 py-2 rounded-lg hover:bg-black/10 backdrop-blur-sm" title="Copia las transacciones del mes anterior">
                               ${createIcon(ICONS.history, 'w-4 h-4')} Repetir Mes Anterior
                            </button>
                            <button id="repeat-yearly-button" data-type="${type}" class="flex items-center gap-2 text-sm ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-3 py-2 rounded-lg hover:bg-black/10 backdrop-blur-sm" title="Copia estas transacciones hasta fin de año">
                               ${createIcon(ICONS.repeat, 'w-4 h-4')} Repetir Anualmente
                            </button>
                        </div>
                    </div>
                    
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-${isExpense ? '4' : '2'} gap-4 mb-8 items-end">                        <div class="${isExpense ? 'md:col-span-2' : ''}">
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Descripción</label>
                            <input type="text" name="description" placeholder="Ej: Salario, Supermercado..." class="w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" required />
                        </div>
                        
                        ${categoryFieldHTML}

                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto</label>
                            <input type="text" inputmode="numeric" name="amount" placeholder="0" class="numeric-input w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" required />
                        </div>

                        <div class="md:col-span-full">
                            <button type="submit" class="w-full mt-2 ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-opacity ${appState.theme.accentGlow} flex items-center justify-center gap-2">
                                ${createIcon(ICONS.plus)} Agregar ${title.slice(0,-1)}
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">Historial del Mes</h3>
                        <ul class="space-y-3">
                            ${transactionsHTML || `<p class="${appState.theme.textSecondary} text-center py-4">No hay transacciones aún.</p>`}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderInvestmentsView() {
            const { totalInvestments } = calculateSummary();
            const totalInitial = appState.data.investments.reduce((sum, i) => sum + i.initialAmount, 0);
            const portfolioPerformance = totalInitial === 0 ? 0 : ((totalInvestments - totalInitial) / totalInitial) * 100;
            const performanceClass = portfolioPerformance >= 0 ? appState.theme.positive : appState.theme.negative;

            const investmentsHTML = appState.data.investments.map(inv => {
                const performance = inv.initialAmount === 0 ? 0 : ((inv.currentAmount - inv.initialAmount) / inv.initialAmount) * 100;
                return `
                    <div class="bg-black/20 p-4 rounded-lg flex flex-col justify-between backdrop-blur-md">
                        <div class="flex justify-between items-start">
                           <div>
                                <p class="font-bold text-lg ${appState.theme.textPrimary}">${inv.name}</p>
                                <p class="text-sm ${appState.theme.textSecondary}">${inv.type}</p>
                           </div>
                           <button class="delete-investment-button text-red-500/70 hover:text-red-500" data-investment-id="${inv.id}">${createIcon(ICONS.trash, 'w-5 h-5')}</button>
                        </div>
                        <div class="mt-4">
                            <label class="text-xs ${appState.theme.textSecondary}">Valor Actual</label>
                            <input type="text" inputmode="numeric" data-investment-id="${inv.id}" value="${formatNumberWithDots(inv.currentAmount)}" placeholder="0" class="numeric-input investment-update-input w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" />
                            <p class="mt-2 text-right text-sm font-semibold ${performance >= 0 ? appState.theme.positive : appState.theme.negative}">${performance.toFixed(2)}%</p>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} mb-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-4">Resumen de Cartera</h2>
                    <div class="flex justify-between items-center">
                        <div><p class="text-sm ${appState.theme.textSecondary}">Valor Total</p><p class="text-3xl font-bold ${appState.theme.textPrimary}">${formatCurrency(totalInvestments)}</p></div>
                        <div class="text-right"><p class="text-sm ${appState.theme.textSecondary}">Rendimiento</p><div class="text-3xl font-bold flex items-center gap-2 ${performanceClass}"><span>${portfolioPerformance > 0 ? '+':''}${portfolioPerformance.toFixed(2)}%</span></div></div>
                    </div>
                </div>
                <div class="backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface}">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">Añadir Activo</h2>
                    <form id="investment-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 items-end">
                        <div class="md:col-span-2"><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Activo</label><input name="name" type="text" placeholder="Ej: Fondo Mutuo Planeta X" class="w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" required /></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Tipo</label><select name="type" class="w-full bg-black/20 text-white rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md"><option class="bg-slate-800">Acciones</option><option class="bg-slate-800">Cripto</option><option class="bg-slate-800">Fondos</option><option class="bg-slate-800">Otro</option></select></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Inversión Inicial</label><input name="initialAmount" type="text" inputmode="numeric" placeholder="0" class="numeric-input w-full bg-white/10 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none" required /></div>
                        <div class="md:col-span-4"><button type="submit" class="w-full mt-2 ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-opacity ${appState.theme.accentGlow} flex items-center justify-center gap-2">${createIcon(ICONS.plus)}Añadir Inversión</button></div>
                    </form>
                    <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mt-8 mb-4">Mis Activos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${investmentsHTML || `<p class="${appState.theme.textSecondary} text-center py-4 col-span-full">Tu cartera de inversiones está vacía.</p>`}</div>
                </div>
            `;
        }
        
        function renderGoalsView() {
             const goalsHTML = appState.data.goals.map(goal => `
                <div class="bg-white/5 p-4 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold ${appState.theme.textPrimary}">${goal.name}</p>
                            <p class="text-sm ${appState.theme.textSecondary} mt-1">${formatCurrency(goal.saved)} / ${formatCurrency(goal.target)}</p>
                        </div>
                        <button class="delete-goal-button text-red-500/70 hover:text-red-500" data-goal-id="${goal.id}">${createIcon(ICONS.trash, 'w-5 h-5')}</button>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div class="${appState.theme.accentBg} h-2.5 rounded-full" style="width: ${((goal.saved / goal.target) * 100)}%"></div>
                    </div>
                </div>
            `).join('');            return `
                <div class="${appState.theme.surface} rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">Metas de Ahorro</h2>
                    <form id="goal-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Nombre de la Meta</label><input type="text" name="name" placeholder="Ej: Viaje a Marte" class="w-full bg-white/10 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none" required /></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto Objetivo</label><input type="text" inputmode="numeric" name="target" placeholder="0" class="numeric-input w-full bg-white/10 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none" required /></div>
                        <div class="self-end"><button type="submit" class="w-full ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-colors ${appState.theme.accentGlow} flex items-center justify-center gap-2">${createIcon(ICONS.plus)}Crear Meta</button></div>
                    </form>
                    <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mt-8 mb-4">Mis Metas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${goalsHTML || `<p class="${appState.theme.textSecondary} col-span-full text-center py-4">Aún no has definido metas.</p>`}</div>
                </div>
            `;
        }        function renderDebtsView() {
            const debtsHTML = appState.data.debts.map(debt => `
                <li class="backdrop-blur-sm rounded-lg flex justify-between items-center p-4 ${appState.theme.surface}">
                    <div><p class="font-semibold ${appState.theme.textPrimary}">${debt.description}</p></div>
                    <div class="flex items-center gap-4">
                        <p class="font-bold text-lg ${appState.theme.negative}">${formatCurrency(debt.amount)}</p>
                        <button class="delete-debt-button text-red-500/70 hover:text-red-500 transition-colors" data-debt-id="${debt.id}">${createIcon(ICONS.trash, 'w-5 h-5')}</button>
                    </div>
                </li>
            `).join('');            return `
                <div class="${appState.theme.surface} rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">💳 Gestión de Deudas</h2>
                    <form id="debt-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">
                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Descripción</label>
                            <input type="text" name="description" placeholder="Ej: Préstamo estudiantil" class="w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto Total</label>
                            <input type="text" inputmode="numeric" name="amount" placeholder="0" class="numeric-input w-full bg-black/20 ${appState.theme.textPrimary} rounded-md p-2 border border-white/20 focus:ring-2 ${appState.theme.accentRing} focus:outline-none backdrop-blur-md" required />
                        </div>
                        <div class="self-end">
                            <button type="submit" class="w-full ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-all ${appState.theme.accentGlow} flex items-center justify-center gap-2 transform hover:scale-105">
                                ${createIcon(ICONS.plus)} Agregar Deuda
                            </button>
                        </div>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">Deudas Actuales</h3>
                        <ul class="space-y-3">
                            ${debtsHTML || `<div class="text-center py-8"><p class="${appState.theme.textSecondary}">🎉 ¡No tienes deudas registradas!</p></div>`}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderSettingsView() {
            const themesHTML = Object.entries(THEMES).map(([key, theme]) => `
                <button data-theme-key="${key}" class="theme-selector p-4 rounded-lg border-2 transition-all ${appState.themeKey === key ? `${theme.accentBorder} scale-105 shadow-lg` : 'border-transparent opacity-70 hover:opacity-100'}">
                    <div class="w-full h-16 rounded-md mb-2" style="background: ${theme.gradient}"></div>
                    <p class="${appState.theme.textPrimary}">${theme.name}</p>
                </button>
            `).join('');            return `
                <div class="${appState.theme.surface} rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">⚙️ Ajustes y Personalización</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">🎨 Tema Visual</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${themesHTML}</div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">🛠️ Herramientas</h3>
                             <button id="open-shortcuts-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md">
                                ${createIcon(ICONS.zap, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">⚡ Atajos de Teclado</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Navega más rápido por la aplicación.</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderComingSoon(section = 'Esta sección') {
            const label = { achievements: 'Logros' }[section] || 'Esta sección';
            return `
                <div class="backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} text-center h-[calc(100vh-200px)] flex flex-col justify-center items-center">
                    <div class="w-24 h-24 text-cyan-400 mb-4 animate-pulse">${createIcon(ICONS.settings)}</div>
                    <h2 class="text-3xl font-bold ${appState.theme.textPrimary}">${label} en Construcción</h2>
                    <p class="mt-4 ${appState.theme.textSecondary}">¡Estamos explorando esta galaxia! Vuelve pronto.</p>
                </div>
            `;
        }        function renderDock() {
            const navItems = [
                { id: 'dashboard', label: 'Resumen', icon: ICONS.dashboard, key: 'D' },
                { id: 'income', label: 'Ingresos', icon: ICONS.income, key: 'I' },
                { id: 'expenses', label: 'Gastos', icon: ICONS.expenses, key: 'G' },
                { id: 'investments', label: 'Inversiones', icon: ICONS.investments, key: 'N' },
                { id: 'debts', label: 'Deudas', icon: ICONS.debts, key: 'P' },
                { id: 'goals', label: 'Metas', icon: ICONS.goals, key: 'M' },
                { id: 'settings', label: 'Ajustes', icon: ICONS.settings, key: 'A' }
            ];

            const navButtonsHTML = navItems.map(item => `
                <button data-view="${item.id}" aria-label="${item.label}" 
                        class="nav-button p-3 w-16 h-16 flex items-center justify-center
                               ${appState.activeView === item.id ? `text-white active` : `${appState.theme.textSecondary} hover:text-white`}" 
                        title="${item.label} (${item.key})">
                    ${createIcon(item.icon, "w-6 h-6")}
                </button>
            `).join('');            return `
                <nav class="p-4 backdrop-blur-lg bg-black/20">
                    <div class="dock-container w-full max-w-md mx-auto flex justify-between items-center">
                        ${navButtonsHTML}
                    </div>
                </nav>`;
        }
          function renderParallaxBackground() {
            if (parallaxBg.children.length > 0 && parallaxBg.dataset.theme === appState.themeKey) return '';
            parallaxBg.dataset.theme = appState.themeKey;

            switch(appState.theme.particleType) {
                case 'goldenDust': {
                    // Polvo dorado flotante para Áureo Amanecer
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-amber-200 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }

                case 'crimsonMist': {
                    // Niebla carmesí para Crisón Vespertino
                    return Array.from({ length: 20 }).map(() => {
                        const duration = Math.random() * 30 + 15;
                        const size = Math.random() * 300 + 150;
                        const startX = Math.random() * 100;
                        const startY = Math.random() * 100;
                        return `<div class="particle absolute rounded-full" style="left: ${startX}%; top: ${startY}%; width: ${size}px; height: ${size}px; background: radial-gradient(circle, ${appState.theme.sunColor}08, transparent 70%); animation: drift ${duration}s linear infinite alternate; transform: translateZ(0);"></div>`;
                    }).join('') + Array.from({ length: 180 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const pulse = Math.random() * 4 + 3;
                        return `<div class="absolute w-px h-px bg-rose-300 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: pulse ${pulse}s ease-in-out infinite;"></div>`;
                    }).join('');
                }

                case 'aquaFlow': {
                    // Flujo acuático para Aguamarina Celeste
                    const waves = Array.from({ length: 8 }).map((_, i) => {
                        const delay = i * 0.5;
                        return `<div class="absolute inset-0 opacity-10" style="background: radial-gradient(ellipse at ${20 + i*10}% ${30 + i*8}%, ${appState.theme.sunColor}15, transparent 60%); animation: wave ${8 + i}s ease-in-out infinite; animation-delay: ${delay}s;"></div>`;
                    }).join('');

                    const bubbles = Array.from({ length: 25 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const size = Math.random() * 8 + 3;
                        const duration = Math.random() * 6 + 4;
                        return `<div class="particle absolute rounded-full border border-cyan-300/20" style="left: ${leftPos}%; bottom: -10px; width: ${size}px; height: ${size}px; background: radial-gradient(circle at 30% 30%, ${appState.theme.sunColor}20, transparent 70%); animation: bubble ${duration}s linear infinite;"></div>`;
                    }).join('');

                    const stars = Array.from({ length: 200 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const shimmer = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-cyan-200 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: shimmer ${shimmer}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return waves + bubbles + stars;
                }

                case 'royalAura': {
                    // Aura real para Violeta Real
                    const orbs = Array.from({ length: 12 }).map(() => {
                        const angle = Math.random() * 360;
                        const radius = Math.random() * 40 + 20;
                        const size = Math.random() * 20 + 10;
                        const duration = Math.random() * 15 + 10;
                        return `<div class="particle absolute rounded-full" style="left: 50%; top: 50%; width: ${size}px; height: ${size}px; background: radial-gradient(circle, ${appState.theme.sunColor}40, transparent 70%); transform-origin: 0 0; animation: orbit ${duration}s linear infinite; --angle: ${angle}deg; --radius: ${radius}vh;"></div>`;
                    }).join('');

                    const sparkles = Array.from({ length: 80 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const sparkle = Math.random() * 2 + 1;
                        const delay = Math.random() * 5;
                        return `<div class="absolute" style="left:${leftPos}%; top:${topPos}%; animation: sparkle ${sparkle}s ease-in-out infinite; animation-delay: ${delay}s;"><div class="w-1 h-1 bg-purple-200 rounded-full"></div></div>`;
                    }).join('');

                    const starField = Array.from({ length: 300 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const glow = Math.random() * 4 + 2;
                        return `<div class="absolute w-px h-px bg-purple-100 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: glow ${glow}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return orbs + sparkles + starField;
                }

                default: return '';
            }
        }        function updateDockGlider() {
            // El nuevo efecto es puramente CSS, no requiere JavaScript
        }/**
         * 🎮 Gestor de Event Listeners Mejorado
         * Maneja todos los eventos de la interfaz de usuario
         */
        function addEventListeners() {
            // Eventos de autenticación
            document.querySelectorAll('.login-button').forEach(btn => 
                btn.addEventListener('click', e => appState.login(e.currentTarget.dataset.loginMethod))
            );
            
            // Navegación del dock
            document.querySelectorAll('.nav-button').forEach(btn => 
                btn.addEventListener('click', (e) => appState.setView(e.currentTarget.dataset.view))
            );
            
            // Toggle de privacidad
            const privacyToggle = document.getElementById('privacy-toggle');
            if(privacyToggle) privacyToggle.addEventListener('click', () => appState.togglePrivacy());
            
            // Formato numérico automático
            document.querySelectorAll('.numeric-input').forEach(input => {
                input.addEventListener('input', e => {
                    const cursorPosition = e.target.selectionStart;
                    const originalLength = e.target.value.length;
                    const rawValue = e.target.value.replace(/\D/g, '');
                    e.target.value = formatNumberWithDots(rawValue);
                    const newLength = e.target.value.length;
                    e.target.setSelectionRange(cursorPosition + (newLength - originalLength), cursorPosition + (newLength - originalLength));
                });
            });            // 🔒 Formularios con protección XSS
            const transactionForm = document.getElementById('transaction-form');
            if (transactionForm) {
                transactionForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const transactionData = {
                        type: appState.activeView === 'income' ? 'income' : 'expense',
                        description: sanitizeHTML(e.target.elements.description.value),
                        category: e.target.elements.category ? sanitizeHTML(e.target.elements.category.value) : undefined,
                        amount: parseFormattedNumber(e.target.elements.amount.value)
                    };
                    
                    appState.addTransaction(transactionData);
                    e.target.reset();
                    
                    NotificationSystem.success('Éxito', 
                        `${transactionData.type === 'income' ? 'Ingreso' : 'Gasto'} agregado correctamente`);
                });
            }

            const investmentForm = document.getElementById('investment-form');
            if(investmentForm) {
                investmentForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const initial = parseFormattedNumber(e.target.elements.initialAmount.value);
                    appState.addInvestment({ 
                        name: sanitizeHTML(e.target.elements.name.value), 
                        type: sanitizeHTML(e.target.elements.type.value), 
                        initialAmount: initial, 
                        currentAmount: initial 
                    });
                    e.target.reset();
                    NotificationSystem.success('Éxito', 'Inversión agregada correctamente');
                });
            }
            
            const goalForm = document.getElementById('goal-form');
            if (goalForm) {
                goalForm.addEventListener('submit', e => {
                    e.preventDefault();
                    appState.addGoal({ 
                        name: sanitizeHTML(e.target.elements.name.value), 
                        target: parseFormattedNumber(e.target.elements.target.value) 
                    });
                    e.target.reset();
                    NotificationSystem.success('Éxito', 'Meta creada correctamente');
                });
            }
            
            const debtForm = document.getElementById('debt-form');
            if(debtForm) {
                debtForm.addEventListener('submit', e => {
                    e.preventDefault();
                    appState.addDebt({ 
                        description: sanitizeHTML(e.target.elements.description.value), 
                        amount: parseFormattedNumber(e.target.elements.amount.value)
                    });
                    e.target.reset();
                    NotificationSystem.success('Éxito', 'Deuda registrada correctamente');
                });
            }
            
            // Botones de repetición
            const repeatButton = document.getElementById('repeat-month-button');
            if (repeatButton) {
                repeatButton.addEventListener('click', e => {
                    appState.repeatPreviousMonth(e.currentTarget.dataset.type);
                });
            }
            
            const repeatYearlyButton = document.getElementById('repeat-yearly-button');
            if (repeatYearlyButton) {
                repeatYearlyButton.addEventListener('click', e => {
                    appState.repeatYearlyFromCurrent(e.currentTarget.dataset.type);
                });
            }

            // Eliminación de elementos
            document.querySelectorAll('.delete-transaction-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteTransaction(parseInt(e.currentTarget.dataset.transactionId));
                    NotificationSystem.info('Eliminado', 'Transacción eliminada');
                })
            );
            
            document.querySelectorAll('.investment-update-input').forEach(input => 
                input.addEventListener('input', e => 
                    appState.updateInvestment(parseInt(e.target.dataset.investmentId), parseFormattedNumber(e.target.value))
                )
            );
            
            document.querySelectorAll('.delete-investment-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteInvestment(parseInt(e.currentTarget.dataset.investmentId));
                    NotificationSystem.info('Eliminado', 'Inversión eliminada');
                })
            );
            
            document.querySelectorAll('.delete-goal-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteGoal(parseInt(e.currentTarget.dataset.goalId));
                    NotificationSystem.info('Eliminado', 'Meta eliminada');
                })
            );
            
            document.querySelectorAll('.delete-debt-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteDebt(parseInt(e.currentTarget.dataset.debtId));
                    NotificationSystem.info('Eliminado', 'Deuda eliminada');
                })
            );
            
            // Selección de temas
            document.querySelectorAll('.theme-selector').forEach(btn => 
                btn.addEventListener('click', (e) => {
                    appState.setTheme(e.currentTarget.dataset.themeKey);
                    NotificationSystem.success('Tema cambiado', 
                        `Aplicado: ${THEMES[e.currentTarget.dataset.themeKey].name}`);
                })
            );
            
            // Navegación de meses
            const monthPrev = document.getElementById('month-prev');
            if (monthPrev) monthPrev.addEventListener('click', () => appState.changeMonth(-1));
            
            const monthNext = document.getElementById('month-next');
            if (monthNext) monthNext.addEventListener('click', () => appState.changeMonth(1));
            
            // Calendario desplegable
            const calendarDropdownButton = document.getElementById('calendar-dropdown-button');
            const calendarDropdown = document.getElementById('calendar-dropdown');
            
            if (calendarDropdownButton && calendarDropdown) {
                calendarDropdownButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    calendarDropdown.classList.toggle('hidden');
                });
                
                // Cerrar dropdown al hacer click fuera
                document.addEventListener('click', (e) => {
                    if (!calendarDropdown.contains(e.target) && !calendarDropdownButton.contains(e.target)) {
                        calendarDropdown.classList.add('hidden');
                    }
                });
                
                // Selección de mes
                document.querySelectorAll('.month-dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const monthIndex = parseInt(e.target.dataset.month);
                        appState.currentDate = new Date(appState.currentDate.getFullYear(), monthIndex, 1);
                        calendarDropdown.classList.add('hidden');
                        renderApp();
                    });
                });
                
                // Botón "ir a hoy"
                const todayShortcut = document.getElementById('today-shortcut');
                if (todayShortcut) {
                    todayShortcut.addEventListener('click', () => {
                        appState.currentDate = new Date();
                        calendarDropdown.classList.add('hidden');
                        renderApp();
                        NotificationSystem.info('Navegación', 'Has regresado al mes actual');
                    });
                }
            }
              // Modal calendar (mantenido para compatibilidad)
            const openCalendarButton = document.getElementById('open-calendar-button');
            if(openCalendarButton) openCalendarButton.addEventListener('click', () => appState.openModal('calendar'));
            
            const openShortcutsButton = document.getElementById('open-shortcuts-button');
            if (openShortcutsButton) openShortcutsButton.addEventListener('click', () => appState.openModal('shortcuts'));            // Actualizar glider al cargar eventos
            updateDockGlider();
            
            // Observer simple para cambios de tamaño
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateDockGlider, 100);
            });
        }

        function addModalEventListeners() {
            const modalContainer = document.querySelector('.modal-container');
            if(modalContainer) {
                modalContainer.addEventListener('click', (e) => {
                    if(e.target === modalContainer) appState.closeModal();
                });
                modalContainer.querySelector('.modal-close-button')?.addEventListener('click', () => appState.closeModal());
            }

            if (appState.activeModal === 'calendar') {
                document.getElementById('calendar-year-prev')?.addEventListener('click', () => appState.changeCalendarYear(-1));
                document.getElementById('calendar-year-next')?.addEventListener('click', () => appState.changeCalendarYear(1));
                document.getElementById('today-button')?.addEventListener('click', () => appState.goToday());
                const yearInput = document.getElementById('calendar-year-input');
                if (yearInput) yearInput.addEventListener('change', e => appState.setCalendarYear(parseInt(e.target.value)));
                document.querySelectorAll('.month-button').forEach(btn => btn.addEventListener('click', e => appState.setCalendarDate(parseInt(e.currentTarget.dataset.monthIndex))));
            }
        }
          // ===============================================
        // 🚀 FUNCIONES DE PERFORMANCE - Optimización de eventos
        /**
         * Debounce para optimizar eventos de input frecuentes
         * @param {Function} func - Función a ejecutar
         * @param {number} wait - Tiempo de espera en ms
         * @returns {Function} Función debounced
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Throttle para limitar ejecución de funciones
         * @param {Function} func - Función a ejecutar
         * @param {number} limit - Límite en ms
         * @returns {Function} Función throttled
         */
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        /**
         * Lazy loading para elementos que aparecen en viewport
         * @param {string} selector - Selector CSS de elementos
         * @param {Function} callback - Función a ejecutar cuando sea visible
         */
        function observeIntersection(selector, callback) {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            callback(entry.target);
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll(selector).forEach(el => observer.observe(el));
            } else {
                // Fallback para navegadores sin IntersectionObserver
                document.querySelectorAll(selector).forEach(callback);
            }        }

        // ===============================================
        // 🧮 FUNCIONES DE CÁLCULO FINANCIERO
        // ===============================================
        
        function calculateSummary() {
            const currentTransactions = appState.data.transactions[appState.currentMonthKey] || [];
            const totalIncome = currentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = currentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const allTransactions = Object.values(appState.data.transactions).flat();
            const totalSavings = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0) - allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalInvestments = appState.data.investments.reduce((sum, i) => sum + i.currentAmount, 0);
            const totalDebts = appState.data.debts.reduce((sum, d) => sum + d.amount, 0);
            
            const balance = totalIncome - totalExpenses;
            const netWorth = totalSavings + totalInvestments - totalDebts;
            
            return { balance, netWorth, totalInvestments, totalDebts, totalIncome, totalExpenses };
        }

        // ===============================================
        // 🚀 SISTEMA DE ATAJOS DE TECLADO RESTAURADO
        // ===============================================
        
        /**
         * � Gestor de Atajos de Teclado Robusto
         * Sistema completo para manejar shortcuts en todos los navegadores
         */
        const ShortcutSystem = {
            shortcuts: new Map(),
            isActive: true,
            
            init() {
                this.registerDefaultShortcuts();
                this.attachListener();
                console.log('✅ ShortcutSystem inicializado correctamente');
            },
            
            /**
             * Registra atajos por defecto de la aplicación
             */
            registerDefaultShortcuts() {
                // Navegación entre vistas
                this.register('d', () => appState.setView('dashboard'), 'Ir al Dashboard');
                this.register('i', () => appState.setView('income'), 'Ir a Ingresos');
                this.register('g', () => appState.setView('expenses'), 'Ir a Gastos');
                this.register('n', () => appState.setView('investments'), 'Ir a Inversiones');
                this.register('p', () => appState.setView('debts'), 'Ir a Deudas');
                this.register('m', () => appState.setView('goals'), 'Ir a Metas');
                this.register('a', () => appState.setView('settings'), 'Ir a Ajustes');
                
                // Navegación temporal
                this.register('ArrowLeft', () => {
                    if (!appState.activeModal) appState.changeMonth(-1);
                }, 'Mes anterior');
                this.register('ArrowRight', () => {
                    if (!appState.activeModal) appState.changeMonth(1);
                }, 'Mes siguiente');
                
                // Funciones especiales
                this.register('Escape', () => {
                    if (appState.activeModal) appState.closeModal();
                }, 'Cerrar modal');
                this.register('c', () => {
                    if (!appState.activeModal) appState.openModal('calendar');
                }, 'Abrir calendario');
                this.register('h', () => {
                    if (!appState.activeModal) appState.openModal('shortcuts');
                }, 'Mostrar atajos');
                this.register('t', () => {
                    appState.togglePrivacy();
                    NotificationSystem.info('Privacidad', 
                        `Modo privado ${appState.isPrivate ? 'activado' : 'desactivado'}`);
                }, 'Alternar privacidad');
            },
            
            /**
             * Registra un nuevo atajo
             */
            register(key, callback, description = '') {
                this.shortcuts.set(key.toLowerCase(), { callback, description });
            },
            
            /**
             * Elimina un atajo
             */
            unregister(key) {
                this.shortcuts.delete(key.toLowerCase());
            },
            
            /**
             * Verifica si una tecla debería ser ignorada
             */
            shouldIgnoreEvent(event) {
                const activeElement = document.activeElement;
                const isInputField = activeElement && 
                    ['INPUT', 'TEXTAREA', 'SELECT'].includes(activeElement.tagName);
                const isContentEditable = activeElement && 
                    activeElement.contentEditable === 'true';
                
                return isInputField || isContentEditable;
            },
            
            /**
             * Maneja el evento de teclado
             */
            handleKeyDown(event) {
                if (!this.isActive || this.shouldIgnoreEvent(event)) {
                    return;
                }
                
                const key = event.key.toLowerCase();
                const shortcut = this.shortcuts.get(key);
                
                if (shortcut) {
                    event.preventDefault();
                    try {
                        shortcut.callback(event);
                    } catch (error) {
                        console.error('Error executing shortcut:', error);
                        NotificationSystem.error('Error', 'Error al ejecutar atajo de teclado');
                    }
                }
            },
            
            /**
             * Adjunta el listener de eventos
             */
            attachListener() {
                document.addEventListener('keydown', (event) => {
                    this.handleKeyDown(event);
                }, { passive: false });
            },
            
            /**
             * Obtiene lista de atajos registrados
             */
            getShortcutsList() {
                return Array.from(this.shortcuts.entries()).map(([key, data]) => ({
                    key: key.toUpperCase(),
                    description: data.description
                }));
            },
            
            /**
             * Activa/desactiva el sistema de shortcuts
             */            setActive(active) {
                this.isActive = active;
            }        };

        // 🎯 DEBUG: Verificar que ShortcutSystem está definido
        console.log('🎯 SHORTCUT SYSTEM STATUS:', typeof ShortcutSystem !== 'undefined' ? '✅ DEFINIDO' : '❌ NO DEFINIDO');

        // ===============================================
        // 🚀 INICIALIZACIÓN MEJORADA PARA LIVE SERVER
        // ===============================================
        
        // Función de inicialización robusta
        function startNebula() {
            try {
                console.log('🚀 Iniciando Nebula Financial...');
                
                // Verificar elementos DOM
                const elements = ['content-root', 'dock-root', 'parallax-bg', 'modal-root'];
                const domElements = elements.map(id => document.getElementById(id));
                
                if (domElements.some(el => !el)) {
                    console.error('❌ Elementos DOM faltantes:', elements.filter((_, i) => !domElements[i]));
                    throw new Error('Elementos DOM no encontrados');
                }
                
                // Asignar elementos a variables globales
                [contentRoot, dockRoot, parallaxBg, modalRoot] = domElements;
                
                // Verificar objetos necesarios
                if (!THEMES || !ICONS || !appState) {
                    throw new Error('Objetos globales no definidos');
                }
                
                // Inicializar sistemas
                ShortcutSystem.init();
                NotificationSystem.init();
                
                // Renderizar aplicación
                renderApp();
                  // Configurar dock
                setTimeout(() => {
                    if (typeof updateDockGlider === 'function') {
                        updateDockGlider();
                    }
                }, 200);
                
                // Mostrar mensaje de bienvenida si es la primera vez
                const isFirstVisit = NebulaSecurityUtils ? 
                    !NebulaSecurityUtils.secureGetItem('nebula_visited') :
                    !localStorage.getItem('nebula_visited');
                if (isFirstVisit) {
                    if (NebulaSecurityUtils) {
                        NebulaSecurityUtils.secureSetItem('nebula_visited', true);
                    } else {
                        localStorage.setItem('nebula_visited', 'true');
                    }
                    setTimeout(() => {
                        NotificationSystem.info('¡Bienvenido!', 
                            'Presiona H para ver los atajos de teclado disponibles', 6000);
                    }, 2000);
                }
                
                console.log('✅ Nebula iniciada correctamente');
                
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
                
                // Mostrar página de error
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); color: white; font-family: 'Inter', Arial, sans-serif;">
                        <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.4); border-radius: 20px; backdrop-filter: blur(10px); max-width: 500px;">
                            <h1 style="font-size: 3rem; margin-bottom: 1rem;">🌌</h1>
                            <h2 style="font-size: 2rem; margin-bottom: 1rem; color: #e2e8f0;">Nebula Financial</h2>
                            <p style="margin-bottom: 1.5rem; color: #cbd5e1; font-size: 1.1rem;">Iniciando tu universo financiero...</p>
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 2rem; text-align: left;">
                                <small style="color: #fcd34d; font-family: monospace;">${error.message}</small>
                            </div>
                            <button onclick="location.reload()" style="background: linear-gradient(45deg, #22c55e, #16a34a); border: none; color: white; padding: 14px 28px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); transition: transform 0.2s; margin-right: 10px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                🔄 Recargar App
                            </button>
                            <button onclick="if(NebulaSecurityUtils) { NebulaSecurityUtils.clearSecurityData(); } else { localStorage.clear(); } location.reload()" style="background: linear-gradient(45deg, #f59e0b, #d97706); border: none; color: white; padding: 14px 28px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">>
                                🗑️ Limpiar Datos
                            </button>
                        </div>
                    </div>
                `;
            }
        }
          // Función de espera para DOM con verificación robusta
        function waitForDOM() {
            console.log('📋 Verificando estado DOM:', document.readyState);
            
            // Verificar que los elementos críticos existan
            const criticalElements = ['app-container', 'content-root', 'dock-root', 'parallax-bg', 'modal-root'];
            const allElementsExist = criticalElements.every(id => {
                const element = document.getElementById(id);
                console.log(`📋 Elemento ${id}:`, element ? '✅ Encontrado' : '❌ No encontrado');
                return element !== null;
            });
            
            if (document.readyState === 'complete' && allElementsExist) {
                console.log('✅ DOM completamente cargado y elementos verificados');
                startNebula();
            } else if (document.readyState === 'interactive' && allElementsExist) {
                console.log('⏳ DOM interactivo, esperando 200ms...');
                setTimeout(() => {
                    const stillExist = criticalElements.every(id => document.getElementById(id));
                    if (stillExist) {
                        startNebula();
                    } else {
                        console.log('🔄 Elementos no listos, esperando evento DOMContentLoaded...');
                        document.addEventListener('DOMContentLoaded', startNebula);
                    }
                }, 200);
            } else {
                console.log('🔄 Esperando carga completa del DOM...');
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('📋 DOMContentLoaded disparado, reintentando...');
                    setTimeout(waitForDOM, 50);
                });
            }
        }// Iniciar aplicación
        waitForDOM();

        // 🧪 SISTEMA DE VALIDACIÓN AUTOMÁTICA
        function validateNebula() {
            setTimeout(() => {
                try {
                    console.log('🧪 Iniciando validación automática de Nebula...');                    const validationResults = {
                        shortcuts: false,
                        notifications: false,
                        appState: false,
                        dom: false,
                        themes: false,
                        security: false,
                        inputValidation: false
                    };
                    
                    // Test ShortcutSystem
                    if (typeof ShortcutSystem !== 'undefined' && ShortcutSystem.init) {
                        console.log('✅ ShortcutSystem: Definido y funcional');
                        validationResults.shortcuts = true;
                    } else {
                        console.error('❌ ShortcutSystem: No definido o no funcional');
                    }
                    
                    // Test NotificationSystem
                    if (typeof NotificationSystem !== 'undefined' && NotificationSystem.success) {
                        console.log('✅ NotificationSystem: Definido y funcional');
                        validationResults.notifications = true;
                    } else {
                        console.error('❌ NotificationSystem: No definido o no funcional');
                    }
                      // Test appState
                    if (typeof appState !== 'undefined' && appState.currentView && appState.data) {
                        console.log('✅ appState: Definido y funcional');
                        validationResults.appState = true;
                    } else {
                        console.error('❌ appState: No definido o no funcional', {
                            defined: typeof appState !== 'undefined',
                            hasCurrentView: typeof appState !== 'undefined' && appState.currentView,
                            hasData: typeof appState !== 'undefined' && appState.data
                        });
                    }
                    
                    // Test DOM elements
                    const criticalIds = ['content-root', 'dock-root', 'parallax-bg', 'modal-root'];
                    const domOk = criticalIds.every(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            console.log(`✅ DOM ${id}: Encontrado`);
                            return true;
                        } else {
                            console.error(`❌ DOM ${id}: No encontrado`);
                            return false;
                        }
                    });
                    validationResults.dom = domOk;                    // Test THEMES
                    if (typeof THEMES !== 'undefined' && THEMES.aureoAmanecer && THEMES.nocheEstelar) {
                        console.log('✅ THEMES: Definido y funcional');
                        validationResults.themes = true;
                    } else {
                        console.error('❌ THEMES: No definido o no funcional', {
                            defined: typeof THEMES !== 'undefined',
                            hasAureoAmanecer: typeof THEMES !== 'undefined' && THEMES.aureoAmanecer,
                            hasNocheEstelar: typeof THEMES !== 'undefined' && THEMES.nocheEstelar
                        });
                    }
                    
                    // Test Security System
                    if (typeof NebulaSecurityUtils !== 'undefined' && NebulaSecurityUtils.encrypt) {
                        console.log('✅ NebulaSecurityUtils: Sistema de seguridad activo');
                        validationResults.security = true;
                        
                        // Test de cifrado básico
                        try {
                            const testData = 'test-encryption';
                            const encrypted = NebulaSecurityUtils.encrypt(testData);
                            const decrypted = NebulaSecurityUtils.decrypt(encrypted);
                            if (decrypted === testData) {
                                console.log('✅ Cifrado/Descifrado: Funcionando correctamente');
                            } else {
                                console.warn('⚠️ Cifrado/Descifrado: Inconsistencia detectada');
                            }
                        } catch (error) {
                            console.error('❌ Error en test de cifrado:', error);
                        }                    } else {
                        console.error('❌ NebulaSecurityUtils: No definido o no funcional');
                    }
                    
                    // Test Input Validation System
                    if (typeof NebulaInputValidator !== 'undefined' && NebulaInputValidator.validateAmount) {
                        console.log('✅ NebulaInputValidator: Sistema de validación activo');
                        validationResults.inputValidation = true;
                        
                        // Test de validación básico
                        try {
                            const testResult = NebulaInputValidator.validateAmount('123.45');
                            if (testResult.isValid && testResult.value === 123.45) {
                                console.log('✅ Validación de entrada: Funcionando correctamente');
                            } else {
                                console.warn('⚠️ Validación de entrada: Comportamiento inesperado');
                            }
                        } catch (error) {
                            console.error('❌ Error en test de validación:', error);
                        }
                    } else {
                        console.error('❌ NebulaInputValidator: No definido o no funcional');
                    }
                    
                    // Calcular resultados
                    const totalTests = Object.keys(validationResults).length;
                    const passedTests = Object.values(validationResults).filter(Boolean).length;
                    const successRate = (passedTests / totalTests * 100).toFixed(1);
                    
                    console.log(`🧪 Validación completada: ${passedTests}/${totalTests} tests pasados (${successRate}%)`);
                    
                    if (passedTests === totalTests) {
                        console.log('🎉 ¡Nebula Financial está funcionando perfectamente!');
                        // Mostrar notificación de éxito
                        if (NotificationSystem && NotificationSystem.success) {
                            NotificationSystem.success('Sistema Validado', 
                                `Todos los componentes funcionan correctamente (${successRate}%)`, 4000);
                        }
                    } else {
                        console.warn(`⚠️ Algunas validaciones fallaron. Revisa la consola para más detalles.`);
                        if (NotificationSystem && NotificationSystem.warning) {
                            NotificationSystem.warning('Validación Parcial', 
                                `${passedTests}/${totalTests} componentes funcionando`, 6000);
                        }
                    }
                    
                    // 🔧 Test rápido de atajos si todo está bien
                    if (validationResults.shortcuts && validationResults.notifications) {
                        console.log('🎮 Para probar atajos: D=Dashboard, I=Ingresos, G=Gastos, H=Ayuda');
                    }
                      } catch (error) {
                    console.error('❌ Error durante la validación:', error);
                }
            }, 5000); // ⏰ CAMBIADO: 5 segundos para asegurar inicialización completa
        }
        
        // Ejecutar validación automáticamente
        if (typeof window !== 'undefined') {
            validateNebula();
        }

        // 🚀 Registro del Service Worker para performance
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            console.log('🔄 Nueva versión del SW disponible');
                        });
                    })
                    .catch(error => {
                        console.log('❌ Error registrando SW:', error);
                    });
            });
        }

    </script>
</body>
</html>
