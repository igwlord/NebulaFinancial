<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Gmail Login - Diagnostico</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
        button { 
            background: #4285f4; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px;
        }
        button:hover { background: #3367d6; }
        #status { 
            margin: 20px 0; 
            padding: 15px; 
            border-radius: 8px; 
            background: #2a2a4e;
        }
        .success { background: #1a4c96 !important; }
        .error { background: #8b0000 !important; }
    </style>
</head>
<body>
    <h1>🔐 Test Gmail Login - Diagnostico</h1>
    <button onclick="testGmailLogin()">🚀 Test Gmail Login</button>
    <button onclick="checkAuthStatus()">📊 Check Auth Status</button>
    <button onclick="testFirebase()">🔥 Test Firebase</button>
    
    <div id="status">Esperando acción...</div>

    <!-- Cargar Firebase -->
    <script type="module">
        const timestamp = Date.now();
        const { getFirebaseConfig } = await import(`./firebase-config.js?t=${timestamp}`);
        const config = getFirebaseConfig();
        
        import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js').then(({ initializeApp }) => {
            import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js').then(({ getAuth, GoogleAuthProvider, signInWithPopup }) => {
                const app = initializeApp(config);
                const auth = getAuth(app);
                const provider = new GoogleAuthProvider();
                
                window.firebaseAuth = auth;
                window.googleProvider = provider;
                window.signInWithPopup = signInWithPopup;
                
                document.getElementById('status').innerHTML = '✅ Firebase configurado correctamente';
                document.getElementById('status').className = 'success';
            });
        });
    </script>

    <!-- Cargar NebulaAuth -->
    <script src="./nebula-auth.js"></script>
    
    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = type;
            console.log(message);
        }

        async function testGmailLogin() {
            try {
                updateStatus('🔄 Iniciando test de Gmail login...', 'info');
                
                if (!window.NebulaAuth) {
                    throw new Error('NebulaAuth no está disponible');
                }
                
                console.log('🔍 NebulaAuth disponible:', window.NebulaAuth);
                console.log('🔍 Métodos disponibles:', Object.getOwnPropertyNames(window.NebulaAuth));
                
                // Intentar login
                const result = await window.NebulaAuth.loginWithGoogle();
                
                if (result && result.success) {
                    updateStatus(`✅ Login exitoso: ${result.user.displayName}`, 'success');
                } else {
                    updateStatus(`❌ Login falló: ${result.error?.message || 'Error desconocido'}`, 'error');
                }
                
            } catch (error) {
                console.error('❌ Error en test:', error);
                updateStatus(`❌ Error: ${error.message}`, 'error');
            }
        }

        function checkAuthStatus() {
            try {
                if (window.NebulaAuth) {
                    const status = window.NebulaAuth.getCurrentUser();
                    updateStatus(`📊 Estado: ${status.isAuthenticated ? 'Autenticado' : 'No autenticado'}`, 
                                status.isAuthenticated ? 'success' : 'info');
                    console.log('📊 Estado completo:', status);
                } else {
                    updateStatus('❌ NebulaAuth no disponible', 'error');
                }
            } catch (error) {
                updateStatus(`❌ Error checking status: ${error.message}`, 'error');
            }
        }

        function testFirebase() {
            try {
                if (window.firebaseAuth && window.googleProvider && window.signInWithPopup) {
                    updateStatus('✅ Firebase Auth disponible y configurado', 'success');
                    
                    // Test directo de Firebase
                    window.signInWithPopup(window.firebaseAuth, window.googleProvider)
                        .then((result) => {
                            updateStatus(`✅ Firebase login directo exitoso: ${result.user.displayName}`, 'success');
                        })
                        .catch((error) => {
                            updateStatus(`❌ Firebase login directo falló: ${error.message}`, 'error');
                        });
                } else {
                    updateStatus('❌ Firebase Auth no configurado correctamente', 'error');
                }
            } catch (error) {
                updateStatus(`❌ Error testing Firebase: ${error.message}`, 'error');
            }
        }

        // Agregar listener para cambios de autenticación
        setTimeout(() => {
            if (window.NebulaAuth && typeof window.NebulaAuth.addAuthListener === 'function') {
                window.NebulaAuth.addAuthListener((authData) => {
                    console.log('🎉 Auth state changed:', authData);
                    if (authData.isAuthenticated) {
                        updateStatus(`🎉 Usuario autenticado: ${authData.user.displayName}`, 'success');
                    } else {
                        updateStatus('🔓 Usuario desautenticado', 'info');
                    }
                });
                console.log('✅ Auth listener agregado');
            }
        }, 1000);
    </script>
</body>
</html>
